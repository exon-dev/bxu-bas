<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspector Management</title>
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link
   href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
   rel="stylesheet"
  />
  <link
   rel="stylesheet"
   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />
  <style>
   body {
    font-family: "Poppins", sans-serif !important;
    background-color: #eff3fc;
    padding-right: 0 !important;
   }
   .container {
    max-width: 800px;
    margin-top: 40px;
   }
   .card {
    border-radius: 12px;
    /* box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); */
    border: none;
    overflow: hidden;
   }
   .card-header {
    /* background: linear-gradient(135deg, #007bff, #0056b3); */
    /* color: white; */
    padding: 1rem;
   }
   .btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.5rem;
   }
   .btn-primary:hover {
    background: linear-gradient(135deg, #0056b3, #003c82);
   }
   .form-control {
    border-radius: 10px;
    padding: 0.8rem;
    border: 1px solid #dfe3ec;
    transition: box-shadow 0.3s ease;
   }
   .form-control:focus {
    box-shadow: 0 0 4px rgba(0, 123, 255, 0.5);
   }
   .modal-content {
    border-radius: 12px;
    padding: 1.5rem;
   }
   .modal-header {
    border-bottom: none;
   }
   .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
   }
   .modal-body label {
    font-weight: 500;
    margin-bottom: 0.5rem;
   }
   #successModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1050;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    display: none;
   }
   #successModal p {
    margin: 0;
    font-weight: 500;
    color: #28a745;
   }
   .table th,
   .table td {
    vertical-align: middle;
   }
   .modal {
    padding-right: 0 !important;
   }
   .modal-body {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
   }
   .modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
   }
   body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
   }
   .modal {
    overflow-y: hidden !important;
   }
   .modal-dialog {
    overflow-y: initial !important;
   }

   .modal-body {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    overflow-x: hidden;
   }
   .modal-backdrop {
    opacity: 0.2 !important;
   }
   .modal-backdrop.show {
    opacity: 0.2 !important;
   }
   .modal-backdrop.fade {
    opacity: 0.2 !important;
   }
  </style>
 </head>
 <body>
  <div class="">
   <div class="card">
    <div class="card-body">
     <h4>Inspector Management</h4>
    </div>
    <div class="card-body">
     <p>Manage inspector users throughout the BXU BAS System.</p>
     <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#addInspectorModal"
     >
      Add New Inspector
     </button>
    </div>
   </div>

   <!-- Modal -->
   <div
    class="modal fade"
    id="addInspectorModal"
    tabindex="-1"
    aria-labelledby="addInspectorModalLabel"
    aria-hidden="true"
   >
    <div class="modal-dialog modal-dialog-centered">
     <div class="modal-content">
      <div class="modal-header">
       <h5 class="modal-title" id="addInspectorModalLabel">
        Add New Inspector
       </h5>
       <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
       ></button>
      </div>
      <div class="modal-body">
       <form id="addInspectorForm">
        <div class="mb-3">
         <label for="firstName" class="form-label">First Name</label>
         <input
          type="text"
          class="form-control"
          id="firstName"
          name="firstName"
          required
         />
        </div>
        <div class="mb-3">
         <label for="lastName" class="form-label">Last Name</label>
         <input
          type="text"
          class="form-control"
          id="lastName"
          name="lastName"
          required
         />
        </div>
        <div class="mb-3">
         <label for="email" class="form-label">Email</label>
         <input
          type="email"
          class="form-control"
          id="email"
          name="email"
          required
         />
        </div>
        <div class="text-end">
         <button type="submit" class="btn btn-primary" id="addInspectorBtn">
          <span
           class="spinner-border spinner-border-sm me-1 d-none"
           id="addSpinner"
           role="status"
           aria-hidden="true"
          ></span>
          Add Inspector
         </button>
        </div>
       </form>
      </div>
     </div>
    </div>
   </div>

   <!-- Success Modal -->
   <div
    class="modal fade"
    id="addSuccessModal"
    tabindex="-1"
    aria-hidden="true"
   >
    <div class="modal-dialog modal-dialog-centered">
     <div class="modal-content">
      <div class="modal-body text-center py-4">
       <i class="bi bi-check-circle text-success" style="font-size: 3rem"></i>
       <p class="mt-3 mb-0">Inspector added successfully!</p>
      </div>
     </div>
    </div>
   </div>

   <!-- List of Inspectors -->
   <div class="card mt-4">
    <div class="card-body">
     <h4 class="card-title">List of Inspectors</h4>
     <table class="table table-striped">
      <thead>
       <tr>
        <th scope="col">No.</th>
        <th scope="col">Email</th>
        <th scope="col">Full Name</th>
        <th scope="col">Date Created</th>
        <th scope="col">Date Updated</th>
        <th scope="col">No. of Inspections</th>
        <th scope="col">Actions</th>
       </tr>
      </thead>
      <tbody id="inspectorList"></tbody>
     </table>
    </div>
   </div>

   <!-- Add this after your existing modals -->
   <div
    class="modal fade"
    id="deleteConfirmModal"
    tabindex="-1"
    aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true"
   >
    <div class="modal-dialog modal-dialog-centered">
     <div class="modal-content">
      <div class="modal-header">
       <h5 class="modal-title" id="deleteConfirmModalLabel">
        Confirm Deletion
       </h5>
       <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
       ></button>
      </div>
      <div class="modal-body">
       <p>Are you sure you want to delete this inspector?</p>
       <div class="inspector-details mt-3">
        <p class="mb-1">
         <strong>Name:</strong> <span id="deleteInspectorName"></span>
        </p>
        <p class="mb-1">
         <strong>Email:</strong> <span id="deleteInspectorEmail"></span>
        </p>
       </div>
      </div>
      <div class="modal-footer">
       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        Cancel
       </button>
       <button type="button" class="btn btn-danger" id="confirmDelete">
        Delete
       </button>
      </div>
     </div>
    </div>
   </div>

   <!-- Add this success modal for deletion -->
   <div
    class="modal fade"
    id="deleteSuccessModal"
    tabindex="-1"
    aria-hidden="true"
   >
    <div class="modal-dialog modal-dialog-centered">
     <div class="modal-content">
      <div class="modal-body">
       <p class="text-success mb-0">Inspector deleted successfully!</p>
      </div>
     </div>
    </div>
   </div>

   <!-- Error Modal -->
   <div
    class="modal fade"
    id="errorModal"
    tabindex="-1"
    aria-labelledby="errorModalLabel"
    aria-hidden="true"
   >
    <div class="modal-dialog modal-dialog-centered">
     <div class="modal-content">
      <div class="modal-header">
       <h5 class="modal-title" id="errorModalLabel">Error</h5>
       <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
       ></button>
      </div>
      <div class="modal-body">
       <p id="errorMessage"></p>
      </div>
      <div class="modal-footer">
       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        Close
       </button>
      </div>
     </div>
    </div>
   </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
   import CONFIG from "/scripts/config.js";

   const apiUrl = CONFIG.API_BASE_URL;

   // Function to remove any lingering modal backdrops
   function removeModalBackdrops() {
    const backdrops = document.querySelectorAll(".modal-backdrop");
    backdrops.forEach((backdrop) => backdrop.remove());
   }

   // Get modal elements
   const addModalElement = document.getElementById("addInspectorModal");
   const errorModalElement = document.getElementById("errorModal");

   // Add new inspector
   const addInspector = async (event) => {
    event.preventDefault();

    const submitButton = document.querySelector("#addInspectorBtn");
    const spinner = document.querySelector("#addSpinner");
    const addModal = bootstrap.Modal.getInstance(addModalElement);
    const successModal = new bootstrap.Modal(
     document.getElementById("addSuccessModal")
    );
    const errorModal = new bootstrap.Modal(errorModalElement);

    // Get form inputs
    const firstName = document.querySelector("#firstName").value.trim();
    const lastName = document.querySelector("#lastName").value.trim();
    const email = document.querySelector("#email").value.trim();

    // Validate required fields
    if (!firstName || !lastName || !email) {
     alert("Please fill out all required fields.");
     return;
    }

    try {
     // Show loading state
     submitButton.disabled = true;
     spinner.classList.remove("d-none");

     // Send POST request to create a new inspector
     const response = await fetch(`${apiUrl}/admin/create-inspector`, {
      method: "POST",
      headers: {
       Accept: "application/json",
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
      body: JSON.stringify({
       first_name: firstName,
       last_name: lastName,
       email: email,
      }),
     });

     const data = await response.json();
     if (response.ok) {
      // Close the add inspector modal
      addModal.hide();

      // Show success modal
      successModal.show();

      // Reset form
      document.querySelector("#addInspectorForm").reset();

      // Refresh the list after 2 seconds
      setTimeout(() => {
       successModal.hide();
       window.location.reload();
      }, 2000);
     } else {
      // Close the add inspector modal
      addModal.hide();

      // Show error modal after the add modal is fully hidden
      addModalElement.addEventListener(
       "hidden.bs.modal",
       () => {
        document.getElementById("errorMessage").textContent =
         data.message || "An error occurred. Please try again.";
        errorModal.show(); // Show the error modal
       },
       { once: true }
      ); // Ensure the listener is removed after execution
     }
    } catch (error) {
     console.error("Error adding inspector:", error);
     // Close the add inspector modal
     addModal.hide();

     // Show error modal after the add modal is fully hidden
     addModalElement.addEventListener(
      "hidden.bs.modal",
      () => {
       document.getElementById("errorMessage").textContent =
        "An unexpected error occurred. Please try again.";
       errorModal.show(); // Show the error modal
      },
      { once: true }
     ); // Ensure the listener is removed after execution
    } finally {
     // Hide loading state
     submitButton.disabled = false;
     spinner.classList.add("d-none");
    }
   };

   // Add event listeners to remove backdrops when modals are hidden
   addModalElement.addEventListener("hidden.bs.modal", removeModalBackdrops);
   errorModalElement.addEventListener("hidden.bs.modal", removeModalBackdrops);
   document
    .getElementById("deleteConfirmModal")
    .addEventListener("hidden.bs.modal", removeModalBackdrops);
   document
    .getElementById("addSuccessModal")
    .addEventListener("hidden.bs.modal", removeModalBackdrops);
   document
    .getElementById("deleteSuccessModal")
    .addEventListener("hidden.bs.modal", removeModalBackdrops);
   document
    .getElementById("errorModal")
    .addEventListener("hidden.bs.modal", removeModalBackdrops);

   // Make deleteInspector function available globally
   globalThis.deleteInspector = async (
    inspector_id,
    firstName,
    lastName,
    email
   ) => {
    let deleteModal = new bootstrap.Modal(
     document.getElementById("deleteConfirmModal")
    );
    let successModal = new bootstrap.Modal(
     document.getElementById("deleteSuccessModal")
    );

    // Set the inspector details in the modal
    document.getElementById(
     "deleteInspectorName"
    ).textContent = `${firstName} ${lastName}`;
    document.getElementById("deleteInspectorEmail").textContent = email;

    deleteModal.show();

    document.getElementById("confirmDelete").onclick = async () => {
     try {
      const response = await fetch(
       `${apiUrl}/admin/delete-inspector/${inspector_id}`,
       {
        method: "DELETE",
        headers: {
         Accept: "application/json",
         "Content-Type": "application/json",
         Authorization: `Bearer ${localStorage.getItem("authToken")}`,
        },
       }
      );

      if (!response.ok) {
       const errorData = await response.json();
       throw new Error(errorData.message || "Failed to delete inspector");
      }

      deleteModal.hide();
      successModal.show();

      // Hide success modal and refresh after 2 seconds
      setTimeout(() => {
       successModal.hide();
       fetchInspectors();
      }, 2000);
     } catch (error) {
      console.error("Delete error:", error);
      deleteModal.hide();
      alert(`Error deleting inspector: ${error.message}`);
     }
    };
   };

   // Event listener for form submission
   document
    .querySelector("#addInspectorForm")
    .addEventListener("submit", addInspector);

   // getting all inspectors
   const inspectorList = document.getElementById("inspectorList");
   const messageDiv = document.getElementById("message");

   // Fetch and display inspectors
   const fetchInspectors = async () => {
    try {
     const response = await fetch(`${apiUrl}/admin/inspectors`, {
      method: "GET",
      headers: {
       Accept: "application/json",
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
     });

     if (!response.ok) {
      throw new Error("Failed to fetch inspectors");
     }

     const inspectors = await response.json();

     inspectorList.innerHTML = "";
     inspectors.inspectors.forEach((inspector, index) => {
      const row = document.createElement("tr");

      // Escape any special characters to prevent issues in innerHTML
      const escapeHtml = (str) => {
       return str.replace(/[&<>"']/g, (char) => {
        const map = {
         "&": "&amp;",
         "<": "&lt;",
         ">": "&gt;",
         '"': "&quot;",
         "'": "&#39;",
        };
        return map[char] || char;
       });
      };

      row.innerHTML = `
           <th scope="row">${index + 1}</th>
           <td>${escapeHtml(inspector.email)}</td>
           <td>${escapeHtml(inspector.first_name)} ${escapeHtml(
       inspector.last_name
      )}</td>
           <td>${new Date(inspector.created_at).toLocaleDateString()}</td>
           <td>${new Date(inspector.updated_at).toLocaleDateString()}</td>
           <td>${inspector.inspections_count}</td>
           <td>
               <button
                   class="btn btn-danger btn-sm delete-inspector"
                   data-inspector-id="${inspector.inspector_id}"
                   data-first-name="${escapeHtml(inspector.first_name)}"
                   data-last-name="${escapeHtml(inspector.last_name)}"
                   data-email="${escapeHtml(inspector.email)}"
               >
                   Delete
               </button>
           </td>
       `;
      inspectorList.appendChild(row);
     });

     // Add event listeners for delete buttons
     document.querySelectorAll(".delete-inspector").forEach((button) => {
      button.addEventListener("click", async (e) => {
       const inspectorId = e.target.dataset.inspectorId;
       const firstName = e.target.dataset.firstName;
       const lastName = e.target.dataset.lastName;
       const email = e.target.dataset.email;
       await deleteInspector(inspectorId, firstName, lastName, email);
      });
     });
    } catch (error) {
     messageDiv.innerHTML = `
             <div class="alert alert-danger" role="alert">
               Error fetching inspectors: ${error.message}
             </div>
           `;
    }
   };

   fetchInspectors();
  </script>
 </body>
</html>
