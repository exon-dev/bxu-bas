<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Violations</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link
   href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
   rel="stylesheet"
  />
  <style>
   body {
    font-family: "Poppins", Arial, sans-serif !important;
    background-color: #eff3fc;
    margin: 0;
    padding: 0;
   }
   .container {
    width: 80%;
    margin: 0 auto;
    padding: 20px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
   }
   h4 {
    color: #333;
   }
   .table {
    margin-top: 20px;
   }
   .spinner {
    display: flex;
    justify-content: center;
    margin-top: 20px;
   }
   tr:hover {
    background-color: #f1f1f1;
   }
   .footer {
    text-align: center;
    padding: 20px;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
   }
   .card {
    border-radius: 10px;
    box-shadow: 0 1px 2.94px rgba(4, 26, 55, 0.16);
    border: none;
    margin-bottom: 30px;
    transition: all 0.3s ease-in-out;
   }
  </style>
 </head>
 <body id="violations">
  <section>
   <div class="card">
    <div class="card-body">
     <h4>Business Inspections</h4>
     <p>Inspect businesses and create violations for business violators.</p>
    </div>
   </div>
  </section>
  <div class="mt-3">
   <section class="card">
    <div class="card-body">
     <h4>Inspected Businesses</h4>
     <!-- <div class="spinner" id="loading-inspections">
      <div class="spinner-border text-primary" role="status">
       <span class="visually-hidden">Loading...</span>
      </div>
     </div> -->
     <table class="table">
      <thead>
       <tr>
        <th>Business Name</th>
        <th>Business ID</th>
        <th>Inspector ID</th>
        <th>Inspection Date</th>
        <th>Type of Inspection</th>
        <th>With Violations</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </section>
  </div>
  <!-- <div class="mt-3">
   <section class="card">
    <div class="card-body">
     <h4>List of Violators</h4>
     <div class="spinner" id="loading-violators">
      <div class="spinner-border text-primary" role="status">
       <span class="visually-hidden">Loading...</span>
      </div>
     </div>
     <table class="table">
      <thead>
       <tr>
        <th>Owner Name</th>
        <th>Business Name</th>
        <th>Business ID</th>
        <th>Status</th>
        <th>Violation Details</th>
        <th>Inspection Date</th>
        <th>Due Date</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </section>
  </div> -->
  <script type="module">
   import CONFIG from "/scripts/config.js";
   const apiUrl = CONFIG.API_BASE_URL;

   const fetchInspections = async () => {
    try {
     const response = await fetch(`${apiUrl}/admin/inspections`, {
      method: "GET",
      headers: {
       Accept: "application/json",
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
     });

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();
     console.log("Fetched Data:", data); // Debugging API response

     // Validate and process inspections
     const inspections = data.inspections || [];
     if (!Array.isArray(inspections)) {
      throw new Error("Invalid API response: `inspections` is not an array");
     }

     // Update the inspected businesses table
     const inspectedBusinessesTableBody =
      document.querySelector("table.table tbody");
     inspectedBusinessesTableBody.innerHTML = ""; // Clear existing rows

     inspections.forEach((inspection) => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${inspection.business.business_name || "N/A"}</td>
        <td>${inspection.business_id || "N/A"}</td>
        <td>${inspection.inspector_id || "N/A"}</td>
        <td>${inspection.inspection_date || "N/A"}</td>
        <td>${inspection.type_of_inspection || "N/A"}</td>
        <td>${inspection.with_violations ? "Yes" : "No"}</td>
      `;

      inspectedBusinessesTableBody.appendChild(row);
     });

     // Update the violators table
     const violatorsTableBody = document
      .querySelectorAll("table.table")[1]
      .querySelector("tbody");
     violatorsTableBody.innerHTML = ""; // Clear existing rows

     inspections
      .filter((inspection) => inspection.with_violations) // Filter inspections with violations
      .forEach((inspection) => {
       const business = inspection.business || {};
       const owner = business.owner || {};

       const row = document.createElement("tr");

       row.innerHTML = `
          <td>${owner.first_name || "N/A"} ${owner.last_name || ""}</td>
          <td>${business.business_name || "N/A"}</td>
          <td>${inspection.business_id || "N/A"}</td>
          <td>${business.status || "N/A"}</td>
          <td>Violation Details</td>
          <td>${inspection.inspection_date || "N/A"}</td>
          <td>Due Date</td>
        `;

       violatorsTableBody.appendChild(row);
      });
    } catch (err) {
     console.error("Error fetching inspections:", err.message);
    }
   };

   fetchInspections();
  </script>
 </body>
</html>
