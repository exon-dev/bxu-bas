<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Violations</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link
   href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
   rel="stylesheet"
  />
  <style>
   body {
    font-family: "Poppins", Arial, sans-serif !important;
    background-color: #eff3fc;
    margin: 0;
    padding: 0;
   }
   .container {
    width: 80%;
    margin: 0 auto;
    padding: 20px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
   }
   h4 {
    color: #333;
   }
   .table {
    margin-top: 20px;
   }
   .spinner {
    display: flex;
    justify-content: center;
    margin-top: 20px;
   }
   tr:hover {
    background-color: #f1f1f1;
   }
   .footer {
    text-align: center;
    padding: 20px;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
   }
   .card {
    border-radius: 10px;
    box-shadow: 0 1px 2.94px rgba(4, 26, 55, 0.16);
    border: none;
    margin-bottom: 30px;
    transition: all 0.3s ease-in-out;
   }
   .filters {
    margin-bottom: 20px;
   }
  </style>
 </head>
 <body id="violations">
  <section>
   <div class="card">
    <div class="card-body">
     <h4>Business Inspections</h4>
     <p>Inspect businesses and create violations for business violators.</p>
    </div>
   </div>
  </section>
  <div class="mt-3">
   <section class="card">
    <div class="card-body">
     <h4>Filter & Search</h4>
     <div class="filters">
      <form id="filters-form">
       <div class="row">
        <div class="col-md-3">
         <label for="inspection-date" class="form-label"
          >Filter by Inspection Date</label
         >
         <input type="date" id="inspection-date" class="form-control" />
        </div>
        <div class="col-md-3">
         <label for="violation" class="form-label">Filter by Violation</label>
         <select id="violation" class="form-select">
          <option value="">Select Violation</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
         </select>
        </div>
        <div class="col-md-3">
         <label for="inspector" class="form-label">Filter by Inspector</label>
         <select id="inspector" class="form-select">
          <!-- Inspector options will be dynamically added here -->
         </select>
        </div>
        <div class="col-md-3">
         <label for="search-name" class="form-label"
          >Search by Business Name</label
         >
         <input
          type="text"
          id="search-name"
          class="form-control"
          placeholder="Search by name"
         />
        </div>
       </div>
      </form>
     </div>
     <h4>Inspected Businesses</h4>
     <table class="table">
      <thead>
       <tr>
        <th>No.</th>
        <th>Business Name</th>
        <th>Business Status</th>
        <th>Inspector</th>
        <th>Inspection Date</th>
        <th>Type of Inspection</th>
        <th>With Violations</th>
       </tr>
      </thead>
      <tbody id="inspections-tbody"></tbody>
     </table>
     <nav>
      <ul class="pagination" id="pagination-controls"></ul>
     </nav>
    </div>
   </section>
  </div>

  <script type="module">
   import CONFIG from "/scripts/config.js";
   const apiUrl = CONFIG.API_BASE_URL;
   const recordsPerPage = 10; // Number of records per page

   let currentPage = 1; // Start with page 1
   let totalPages = 1; // Default value for total pages
   let inspectionsData = [];
   let inspectors = [];

   const renderTable = () => {
    const inspectionsTbody = document.getElementById("inspections-tbody");
    inspectionsTbody.innerHTML = ""; // Clear existing rows

    inspectionsData.forEach((inspection, index) => {
     const row = document.createElement("tr");
     row.innerHTML = ` 
                <td>${index + 1}</td>
                <td>${inspection.business.business_name || "N/A"}</td>
                <td>${inspection.business.status || "N/A"}</td>
                <td>${inspection.inspector_full_name || "N/A"}</td>
                <td>${inspection.inspection_date || "N/A"}</td>
                <td>${inspection.type_of_inspection || "N/A"}</td>
                <td>${inspection.with_violations ? "Yes" : "No"}</td>
            `;
     inspectionsTbody.appendChild(row);
    });

    renderPagination();
   };

   const renderPagination = () => {
    const paginationControls = document.getElementById("pagination-controls");
    paginationControls.innerHTML = ""; // Clear existing controls

    const prevPageButton = document.createElement("li");
    prevPageButton.classList.add("page-item");
    prevPageButton.innerHTML = `
            <a class="page-link" href="#" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
    prevPageButton.addEventListener("click", () => changePage(currentPage - 1));
    if (currentPage === 1) prevPageButton.classList.add("disabled");
    paginationControls.appendChild(prevPageButton);

    for (let i = 1; i <= totalPages; i++) {
     const pageButton = document.createElement("li");
     pageButton.classList.add("page-item");
     pageButton.innerHTML = `
                <a class="page-link" href="#">${i}</a>
            `;
     pageButton.addEventListener("click", () => changePage(i));
     if (i === currentPage) pageButton.classList.add("active");
     paginationControls.appendChild(pageButton);
    }

    const nextPageButton = document.createElement("li");
    nextPageButton.classList.add("page-item");
    nextPageButton.innerHTML = `
            <a class="page-link" href="#" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
    nextPageButton.addEventListener("click", () => changePage(currentPage + 1));
    if (currentPage === totalPages) nextPageButton.classList.add("disabled");
    paginationControls.appendChild(nextPageButton);
   };

   const changePage = (newPage) => {
    if (newPage >= 1 && newPage <= totalPages) {
     currentPage = newPage;
     fetchInspections(currentPage);
    }
   };

   const fetchInspections = async (page = 1) => {
    try {
     // Get filter values directly from elements
     const inspectionDate = document.getElementById("inspection-date").value;
     const violation = document.getElementById("violation").value;
     const inspector = document.getElementById("inspector").value;
     const searchName = document.getElementById("search-name").value;

     // Build query parameters
     const params = new URLSearchParams({
      page: page,
      ...(inspectionDate && { inspection_date: inspectionDate }),
      ...(violation && { with_violations: violation }),
      ...(inspector && { inspector_id: inspector }),
      ...(searchName && { business_name: searchName }),
     });

     const response = await fetch(
      `${apiUrl}/inspection/inspections?${params.toString()}`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();
     inspectionsData = data.inspections.data || [];
     totalPages = data.inspections.last_page || 1;
     renderTable();
    } catch (error) {
     console.error("Error fetching inspections:", error);
    }
   };

   const fetchInspectors = async () => {
    try {
     const response = await fetch(`${apiUrl}/admin/inspectors`, {
      headers: {
       Accept: "application/json",
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
     });

     if (!response.ok) {
      throw new Error("Failed to fetch inspectors");
     }

     const data = await response.json();
     const inspectorSelect = document.getElementById("inspector");

     // Clear existing options except the first one
     inspectorSelect.innerHTML = '<option value="">Select Inspector</option>';

     // Add inspectors to select
     data.inspectors.forEach((inspector) => {
      const option = document.createElement("option");
      option.value = inspector.inspector_id;
      option.textContent = `${inspector.first_name} ${inspector.last_name}`;
      inspectorSelect.appendChild(option);
     });
    } catch (error) {
     console.error("Error fetching inspectors:", error);
    }
   };

   // Update event listener to use debounce for better performance
   let timeoutId;
   document.getElementById("filters-form").addEventListener("input", () => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
     currentPage = 1; // Reset to first page when filtering
     fetchInspections(currentPage);
    }, 300); // Wait 300ms after user stops typing
   });

   // Initialize the page
   fetchInspectors();
   fetchInspections(currentPage);
  </script>
 </body>
</html>
