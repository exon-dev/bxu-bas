<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BXU BAS: Dashboard</title>
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link
   href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css"
   rel="stylesheet"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
   rel="stylesheet"
  />
  <link
   rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.3.0/css/all.min.css"
   integrity="sha512-UJqci0ZyYcQ0AOJkcIkUCxLS2L6eNcOr7ZiypuInvEhO9uqIDi349MEFrqBzoy1QlfcjfURHl+WTMjEdWcv67A=="
   crossorigin="anonymous"
   referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="/css/admin/dashboard.css" />
  <style>
   body {
    font-family: "Poppins", sans-serif !important;
    background-color: #eff3fc;
    padding-right: 0 !important;
   }
   .card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
   }
   .order-card {
    color: #fff;
   }
   .bg-c-pink {
    background: #ff5370;
   }
   .bg-c-blue {
    background: #4099ff;
   }
   .bg-c-green {
    background: #2ed8b6;
   }
   .bg-c-yellow {
    background: #ffb64d;
   }
   .modal {
    padding-right: 0 !important;
   }
   .modal-body {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
   }
   .modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
   }
   body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
   }
   .modal {
    overflow-y: hidden !important;
   }
   .modal-dialog {
    overflow-y: initial !important;
   }
   .modal-body {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    overflow-x: hidden;
   }
  </style>
  <!-- Add SweetAlert2 CSS and JS -->
  <link
   href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css"
   rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link
   rel="stylesheet"
   type="text/css"
   href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
  />
  <script
   type="text/javascript"
   src="https://cdn.jsdelivr.net/npm/toastify-js"
  ></script>
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.min.css"
   rel="stylesheet"
  />
 </head>
 <body id="dashboard">
  <div class="card mb-4">
   <div class="card-body">
    <h4>Dashboard</h4>
    <p>
     Welcome to the BXU BAS Dashboard. Here you can monitor and manage all
     activities related to violators and inspectors.
    </p>
   </div>
  </div>
  <div class="row justify-content-between g-3">
   <div class="col">
    <div class="card bg-c-yellow order-card h-100">
     <div class="card-body">
      <h6 class="mb-2">Total Inspectors</h6>
      <div class="d-flex align-items-center gap-2">
       <i class="fa fa-user-tie text-white" aria-label="Inspectors Icon"></i>
       <h2 id="total_inspectors">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col">
    <div class="card bg-c-blue order-card h-100">
     <div class="card-body">
      <h6 class="mb-2">Total Inspections</h6>
      <div class="d-flex align-items-center gap-2">
       <i class="fa fa-users text-white" aria-label="Inspections Icon"></i>
       <h2 id="total_inspections">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col">
    <div class="card bg-c-green order-card h-100">
     <div class="card-body">
      <h6 class="mb-2">Resolved Inspections</h6>
      <div class="d-flex align-items-center gap-2">
       <i class="fa fa-check-circle text-white" aria-label="Resolved Icon"></i>
       <h2 id="total_resolved_inspections">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col">
    <div class="card bg-c-yellow order-card h-100">
     <div class="card-body">
      <h6 class="mb-2">Total Violations</h6>
      <div class="d-flex align-items-center gap-2">
       <i
        class="fa fa-exclamation-circle text-white"
        aria-label="Violations Icon"
       ></i>
       <h2 id="total_violations">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col">
    <div class="card bg-c-pink order-card h-100">
     <div class="card-body">
      <h6 class="mb-2">Overdue Violations</h6>
      <div class="d-flex align-items-center gap-2">
       <i
        class="fa fa-exclamation-triangle text-white"
        aria-label="Overdue Icon"
       ></i>
       <h2 id="overdue_violations">0</h2>
      </div>
     </div>
    </div>
   </div>
  </div>
  <section class="mt-4">
   <div class="card">
    <div class="card-body">
     <h4>List of Violators</h4>
     <p class="text-secondary">Business establishments with violations</p>
     <div class="table-responsive">
      <table class="table">
       <thead>
        <tr>
         <th>No.</th>
         <th>Business Name</th>
         <th>Owner</th>
         <th>Business Status</th>
         <th>Inspection Date</th>
         <th>Due Date</th>
         <th>Type of Inspection</th>
         <th>Status</th>
        </tr>
       </thead>
       <tbody id="all-violators-tbody"></tbody>
      </table>
     </div>
     <nav>
      <ul
       class="pagination justify-content-end"
       id="all-violators-pagination"
      ></ul>
     </nav>
    </div>
   </div>
  </section>

  <section>
   <div class="card">
    <div class="card-body">
     <h4>Upcoming Due</h4>
     <p class="text-secondary">
      Violator with 3 days or less than 3 days are posted here.
     </p>
     <table class="table">
      <thead>
       <tr>
        <th>No.</th>
        <th>Business Name</th>
        <th>Business Status</th>
        <th>Inspector</th>
        <th>Inspection Date</th>
        <th>Due Date</th>
        <th>Type of Inspection</th>
        <th>Status</th>
       </tr>
      </thead>
      <tbody id="violators-tbody"></tbody>
     </table>
     <nav>
      <ul class="pagination" id="violators-pagination"></ul>
     </nav>
    </div>
   </div>
  </section>

  <section class="mt-4">
   <div class="card">
    <div class="card-body">
     <h4>Overdue Violations</h4>
     <p class="text-secondary">
      Violators without resolving their dues are posted here.
     </p>
     <table class="table">
      <thead>
       <tr>
        <th>No.</th>
        <th>Business Name</th>
        <th>Business Status</th>
        <th>Inspector</th>
        <th>Inspection Date</th>
        <th>Days Overdue</th>
        <th>Status</th>
       </tr>
      </thead>
      <tbody id="overdue-tbody"></tbody>
     </table>
     <nav>
      <ul class="pagination" id="overdue-pagination"></ul>
     </nav>
    </div>
   </div>
  </section>

  <!-- Add this after the Overdue Violations section -->

  <!-- Violation Detail Modal -->
  <div class="modal fade" id="violationDetailModal" tabindex="-1"></div>

  <!-- Add this modal HTML at the bottom of the body, before the scripts -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
   <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
     <div class="modal-body text-center p-4">
      <div class="mb-4">
       <i
        class="bi bi-check-circle-fill text-success"
        style="font-size: 4rem"
       ></i>
      </div>
      <h4 class="mb-3">Resolution Successful!</h4>
      <p class="text-muted mb-4">
       The violation has been successfully resolved.
      </p>
      <button
       type="button"
       class="btn btn-success px-4"
       data-bs-dismiss="modal"
      >
       Close
      </button>
     </div>
    </div>
   </div>
  </div>

  <script type="module">
   import CONFIG from "/scripts/config.js";

   // Make resolveInspection globally available
   window.resolveInspection = async (inspectionId, button) => {
    try {
     // Store original button text before modifying
     const originalText = button.textContent;

     // Disable the button and show loading state
     button.disabled = true;
     button.innerHTML = `
       <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
       Resolving...
     `;

     // Make the API request
     const response = await fetch(
      `${CONFIG.API_BASE_URL}/inspection/resolve-inspection/${inspectionId}`,
      {
       method: "PUT",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     // Check if the response is ok
     if (!response.ok) {
      throw new Error(
       `Failed to resolve violation (Status: ${response.status})`
      );
     }

     // Parse the response
     const data = await response.json();

     // Close the violation details modal first
     const violationDetailModal = bootstrap.Modal.getInstance(
      document.getElementById("violationDetailModal")
     );
     if (violationDetailModal) {
      violationDetailModal.hide();
     }

     // Show success modal
     const successModal = new bootstrap.Modal(
      document.getElementById("successModal")
     );
     successModal.show();

     // Add event listener for when success modal is hidden
     document
      .getElementById("successModal")
      .addEventListener("hidden.bs.modal", function () {
       window.location.reload();
      });
    } catch (error) {
     // Show error message using Toastify
     Toastify({
      text: "Failed to resolve violation. Please try again.",
      duration: 3000,
      gravity: "top",
      position: "right",
      style: {
       background: "linear-gradient(to right, #ff5f6d, #ffc371)",
      },
     }).showToast();

     // Reset button state
     button.disabled = false;
     button.innerHTML = originalText;
    }
   };

   // Also make showAlert globally available
   window.showAlert = (type, message) => {
    Toastify({
     text: message,
     duration: 3000,
     gravity: "top",
     position: "right",
     style: {
      background:
       type === "success"
        ? "linear-gradient(to right, #00b09b, #96c93d)"
        : "linear-gradient(to right, #ff5f6d, #ffc371)",
     },
    }).showToast();
   };
  </script>

  <script type="module">
   import CONFIG from "/scripts/config.js";

   const apiUrl = CONFIG.API_BASE_URL;

   const formatDate = (dateString) => {
    if (!dateString) return "N/A";
    const options = {
     year: "numeric",
     month: "long",
     day: "numeric",
    };
    return new Date(dateString).toLocaleDateString("en-US", options);
   };

   const getCardInfo = async () => {
    try {
     const res = await fetch(apiUrl + "/dashboard/card-info", {
      method: "GET",
      headers: {
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
     });

     if (!res.ok) {
      throw new Error(`Error: ${res.status} - ${res.statusText}`);
     }

     const data = await res.json();
     document.getElementById("total_inspectors").textContent =
      data.total_inspectors === undefined ? 0 : data.total_inspectors;
     document.getElementById("total_inspections").textContent =
      data.total_inspections === undefined ? 0 : data.total_inspections;
     document.getElementById("total_resolved_inspections").textContent =
      data.total_resolved_inspections === undefined
       ? 0
       : data.total_resolved_inspections;
     document.getElementById("total_violations").textContent =
      data.total_violations === undefined ? 0 : data.total_violations;
     document.getElementById("overdue_violations").textContent =
      data.overdue_violations === undefined ? 0 : data.overdue_violations;
    } catch (error) {
     document.getElementById("total_inspectors").textContent = 0;
     document.getElementById("total_inspections").textContent = 0;
     document.getElementById("total_resolved_inspections").textContent = 0;
     document.getElementById("total_violations").textContent = 0;
     document.getElementById("overdue_violations").textContent = 0;
    }
   };

   const getViolators = async (page = 1) => {
    try {
     const violatorsTbody = document.getElementById("violators-tbody");
     // Show loading state
     violatorsTbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
    `;

     const response = await fetch(
      `${apiUrl}/inspection/upcoming-dues?page=${page}&with_violations=yes`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();

     // Clear pagination if no data or empty inspections
     if (!data.inspections || data.inspections.length === 0) {
      document.getElementById("violators-pagination").innerHTML = "";
     }

     renderViolatorsTable(data.inspections || []);
     // Only render pagination if we have data and multiple pages
     if (data.inspections?.length > 0 && data.last_page > 1) {
      renderViolatorsPagination(data.current_page, data.last_page);
     }
    } catch (error) {
     document.getElementById("violators-tbody").innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                Error loading violators. Please try again.
            </td>
        </tr>
    `;
     // Clear pagination on error
     document.getElementById("violators-pagination").innerHTML = "";
    }
   };

   const renderViolatorsTable = (violators) => {
    const violatorsTbody = document.getElementById("violators-tbody");
    violatorsTbody.innerHTML = "";

    if (!violators || violators.length === 0) {
     violatorsTbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">No upcoming dues found</td>
        </tr>
    `;
     return;
    }

    violators.forEach((inspection, index) => {
     const violation = inspection.violations[0]; // Get the first violation
     if (!violation) return; // Skip if no violation exists

     const row = document.createElement("tr");
     row.style.cursor = "pointer";

     row.innerHTML = `
        <td>${index + 1}</td>
        <td>${inspection.business?.business_name || "N/A"}</td>
        <td>${inspection.business?.status || "N/A"}</td>
        <td>${inspection.inspector?.first_name || ""} ${
      inspection.inspector?.last_name || "N/A"
     }</td>
        <td>${formatDate(inspection.inspection_date)}</td>
        <td>${formatDate(violation.due_date)}</td>
        <td>${inspection.type_of_inspection || "N/A"}</td>
        <td>
            <span class="badge ${
             violation.status === "pending"
              ? "bg-warning"
              : violation.status === "paid"
              ? "bg-success"
              : violation.status === "overdue"
              ? "bg-danger"
              : "bg-secondary"
            }">
                ${violation.status.toUpperCase()}
            </span>
        </td>
    `;

     row.addEventListener("click", () => showViolationDetails(inspection));
     violatorsTbody.appendChild(row);
    });
   };

   const renderViolatorsPagination = (currentPage, totalPages) => {
    const paginationElement = document.getElementById("violators-pagination");
    paginationElement.innerHTML = "";

    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton(
     "Previous",
     currentPage > 1,
     () => {
      if (currentPage > 1) getViolators(currentPage - 1);
     },
     "«"
    );
    paginationElement.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
     const pageButton = createPaginationButton(i.toString(), true, () => {
      getViolators(i);
     });
     if (i === currentPage) pageButton.classList.add("active");
     paginationElement.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton(
     "Next",
     currentPage < totalPages,
     () => {
      if (currentPage < totalPages) getViolators(currentPage + 1);
     },
     "»"
    );
    paginationElement.appendChild(nextButton);
   };

   const createPaginationButton = (label, enabled, onClick, symbol = null) => {
    const li = document.createElement("li");
    li.classList.add("page-item");
    if (!enabled) li.classList.add("disabled");

    const a = document.createElement("a");
    a.classList.add("page-link");
    a.href = "#";
    a.innerHTML = symbol || label;
    a.addEventListener("click", (e) => {
     e.preventDefault();
     if (enabled) onClick();
    });

    li.appendChild(a);
    return li;
   };

   const showViolationDetails = (inspection) => {
    try {
     const violation = inspection.violations[0];

     // Create modal HTML
     const modalHTML = `
            <div class="modal fade" id="violationDetailModal" tabindex="-1" aria-labelledby="violationDetailModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content border-0 shadow-sm">
                        <div class="modal-header border-bottom-0 bg-primary bg-gradient text-white">
                            <h5 class="modal-title fw-bold" id="violationDetailModalLabel">
                                <i class="bi bi-clipboard2-check me-2"></i>Violation Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <!-- Business Image Section -->
                            <div class="text-center mb-4">
                                ${
                                 inspection.image_url
                                  ? `<div class="position-relative d-inline-block">
                                        <img src="${CONFIG.APP_URL}/storage/${
                                     inspection.image_url
                                    }" 
                                            alt="Business Image" 
                                            class="rounded-3 shadow-sm" 
                                            style="max-height: 200px; width: auto; object-fit: cover"
                                            onerror="this.onerror=null; this.src='/assets/images/no-image.png';">
                                        <div class="position-absolute bottom-0 start-0 p-2 bg-dark bg-opacity-75 text-white rounded-bottom w-100">
                                            <small>${
                                             inspection.business
                                              ?.business_name || "N/A"
                                            }</small>
                                        </div>
                                    </div>`
                                  : `<div class="text-center p-4 bg-light rounded-3">
                                        <i class="bi bi-building-x display-1 text-muted"></i>
                                        <p class="text-muted mt-2">No business image available</p>
                                    </div>`
                                }
                            </div>

                            <div class="row g-4">
                                <!-- Business Information -->
                                <div class="col-6">
                                    <div class="card border-0 shadow-sm hover-shadow">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="bi bi-building fs-4 text-primary me-2"></i>Business Information
                                            </h6>
                                            <div class="mb-3">
                                                <label class="text-muted small">Business Name</label>
                                                <p class="fw-semibold mb-2">${
                                                 inspection.business
                                                  .business_name || "N/A"
                                                }</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Business Permit</label>
                                                <p class="fw-semibold mb-2">${
                                                 inspection.business
                                                  .business_permit || "N/A"
                                                }</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Status</label>
                                                <p class="mb-0">
                                                    <span class="badge bg-success rounded-pill">${
                                                     inspection.business
                                                      .status || "N/A"
                                                    }</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Owner Information -->
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm hover-shadow">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="bi bi-person fs-4 text-primary me-2"></i>Owner Information
                                            </h6>
                                            <div class="mb-3">
                                                <label class="text-muted small">Owner Name</label>
                                                <p class="fw-semibold mb-2">${
                                                 inspection.business.owner
                                                  .first_name || ""
                                                } ${
      inspection.business.owner.last_name || "N/A"
     }</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">
                                                    <i class="bi bi-envelope-fill me-1"></i>Email
                                                </label>
                                                <p class="fw-semibold mb-2">${
                                                 inspection.business.owner
                                                  .email || "N/A"
                                                }</p>
                                            </div>
                                            <div>
                                                <label class="text-muted small">
                                                    <i class="bi bi-telephone-fill me-1"></i>Phone
                                                </label>
                                                <p class="fw-semibold mb-0">${
                                                 inspection.business.owner
                                                  .phone_number || "N/A"
                                                }</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Inspection Details -->
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm hover-shadow">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="bi bi-clipboard-data fs-4 text-primary me-2"></i>Inspection Details
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="text-muted small">Inspection Date</label>
                                                    <p class="fw-semibold mb-0">${formatDate(
                                                     inspection.inspection_date
                                                    )}</p>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="text-muted small">Type of Inspection</label>
                                                    <p class="fw-semibold mb-0">${
                                                     inspection.type_of_inspection ||
                                                     "N/A"
                                                    }</p>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="text-muted small">Inspector</label>
                                                    <p class="fw-semibold mb-0">${
                                                     inspection.inspector
                                                      .first_name || ""
                                                    } ${
      inspection.inspector.last_name || "N/A"
     }</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Violation Information -->
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm hover-shadow">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="bi bi-clipboard-x fs-4 text-danger me-2"></i>Violation Information
                                            </h6>
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <div class="detail-item">
                                                        <label class="text-muted small">Receipt No.</label>
                                                        <p class="fw-semibold mb-0">${
                                                         violation.violation_receipt_no ||
                                                         "N/A"
                                                        }</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="detail-item">
                                                        <label class="text-muted small">Violation Date</label>
                                                        <p class="fw-semibold mb-0">${formatDate(
                                                         violation.violation_date
                                                        )}</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="detail-item">
                                                        <label class="text-muted small">Due Date</label>
                                                        <p class="fw-semibold mb-0">${formatDate(
                                                         violation.due_date
                                                        )}</p>
                                                    </div>
                                                </div>
                                                ${
                                                 violation.days_overdue
                                                  ? `
                                                    <div class="col-md-4">
                                                        <div class="detail-item">
                                                            <label class="text-muted small">Days Overdue</label>
                                                            <p class="fw-semibold mb-0 text-danger">${violation.days_overdue} days</p>
                                                        </div>
                                                    </div>
                                                `
                                                  : ""
                                                }
                                                <div class="col-12">
                                                    <div class="detail-item">
                                                        <label class="text-muted small">Status</label>
                                                        <p class="mb-0">
                                                            <span class="badge ${
                                                             violation.status?.toLowerCase() ===
                                                             "pending"
                                                              ? "bg-warning"
                                                              : violation.status?.toLowerCase() ===
                                                                "paid"
                                                              ? "bg-success"
                                                              : violation.status?.toLowerCase() ===
                                                                "overdue"
                                                              ? "bg-danger"
                                                              : "bg-secondary"
                                                            } rounded-pill px-3 py-2">
                                                                ${
                                                                 violation.status?.toUpperCase() ||
                                                                 "N/A"
                                                                }
                                                            </span>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="violations-list">
                                                        <h6 class="fw-bold text-danger mb-2">Nature of Violations:</h6>
                                                        <ul class="list-unstyled mb-0">
                                                            ${
                                                             Array.isArray(
                                                              violation.nature_of_violation
                                                             )
                                                              ? violation.nature_of_violation
                                                                 .map(
                                                                  (nature) => `
                                                                       <li class="mb-1">
                                                                           <i class="bi bi-dot text-danger"></i>
                                                                           ${nature
                                                                            .trim()
                                                                            .toUpperCase()}
                                                                       </li>
                                                                   `
                                                                 )
                                                                 .join("")
                                                              : '<li><i class="bi bi-dot"></i> No violations listed</li>'
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            ${
                             violation.status?.toLowerCase() === "pending"
                              ? `
                                <button type="button" class="btn btn-primary" onclick="resolveInspection('${inspection.inspection_id}', this)">
                                    Resolve Violation
                                </button>
                            `
                              : ""
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;

     // Remove existing modal if present
     const existingModal = document.getElementById("violationDetailModal");
     if (existingModal) {
      existingModal.remove();
     }

     // Add modal to DOM
     document.body.insertAdjacentHTML("beforeend", modalHTML);

     // Initialize modal with proper options
     const modalElement = document.getElementById("violationDetailModal");
     const modal = new bootstrap.Modal(modalElement, {
      backdrop: "static",
      keyboard: false,
      focus: true,
     });

     // Add event listeners for proper cleanup
     modalElement.addEventListener("hidden.bs.modal", () => {
      modal.dispose();
      modalElement.remove();
      document.body.classList.remove("modal-open");
      document.body.style.removeProperty("padding-right");
     });

     // Show the modal
     modal.show();
    } catch (error) {
     alert("Error showing violation details. Please try again.");
    }
   };

   const getOverdueViolators = async (page = 1) => {
    try {
     const overdueTbody = document.getElementById("overdue-tbody");
     // Show loading state
     overdueTbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `;

     const response = await fetch(
      `${apiUrl}/inspection/overdue-violations?page=${page}`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();

     // Clear pagination if no data or empty inspections
     if (!data.inspections || data.inspections.length === 0) {
      document.getElementById("overdue-pagination").innerHTML = "";
     }

     renderOverdueTable(data.inspections || []);
     // Only render pagination if we have data and multiple pages
     if (data.inspections?.length > 0 && data.last_page > 1) {
      renderOverduePagination(data.current_page, data.last_page);
     }
    } catch (error) {
     document.getElementById("overdue-tbody").innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Error loading overdue violations. Please try again.
                </td>
            </tr>
        `;
     // Clear pagination on error
     document.getElementById("overdue-pagination").innerHTML = "";
    }
   };

   const renderOverdueTable = (inspections) => {
    const overdueTbody = document.getElementById("overdue-tbody");
    overdueTbody.innerHTML = "";

    if (!Array.isArray(inspections) || inspections.length === 0) {
     overdueTbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">No overdue violations found</td>
            </tr>
        `;
     return;
    }

    inspections.forEach((inspection, index) => {
     const violation = inspection.violations?.[0]; // Safe access of first violation
     if (!violation) return;

     const row = document.createElement("tr");
     row.style.cursor = "pointer";

     row.innerHTML = `
            <td>${index + 1}</td>
            <td>${inspection.business?.business_name || "N/A"}</td>
            <td>${inspection.business?.status || "N/A"}</td>
            <td>${inspection.inspector?.first_name || ""} ${
      inspection.inspector?.last_name || "N/A"
     }</td>
            <td>${formatDate(inspection.inspection_date)}</td>
            <td>
                <span class="badge bg-danger">
                    ${Math.floor(violation.days_overdue)} days
                </span>
            </td>
            <td>
                <span class="badge bg-danger">OVERDUE</span>
            </td>
        `;

     row.addEventListener("click", () => showViolationDetails(inspection));
     overdueTbody.appendChild(row);
    });
   };

   const renderOverduePagination = (currentPage, totalPages) => {
    const paginationElement = document.getElementById("overdue-pagination");
    paginationElement.innerHTML = "";

    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton(
     "Previous",
     currentPage > 1,
     () => {
      if (currentPage > 1) getOverdueViolators(currentPage - 1);
     },
     "«"
    );
    paginationElement.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
     const pageButton = createPaginationButton(i.toString(), true, () =>
      getOverdueViolators(i)
     );
     if (i === currentPage) pageButton.classList.add("active");
     paginationElement.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton(
     "Next",
     currentPage < totalPages,
     () => {
      if (currentPage < totalPages) getOverdueViolators(currentPage + 1);
     },
     "»"
    );
    paginationElement.appendChild(nextButton);
   };

   const getAllViolators = async (page = 1) => {
    try {
     const violatorsTbody = document.getElementById("all-violators-tbody");
     violatorsTbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
     `;

     const response = await fetch(
      `${apiUrl}/violation/all-violators?page=${page}`,
      {
       headers: {
        Accept: "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();

     // Clear pagination if no data or empty inspections
     if (!data.inspections.data || data.inspections.data.length === 0) {
      document.getElementById("all-violators-pagination").innerHTML = "";
     }

     renderAllViolatorsTable(data.inspections.data || []);
     // Only render pagination if we have data and multiple pages
     if (data.inspections.data?.length > 0 && data.inspections.last_page > 1) {
      renderAllViolatorsPagination(
       data.inspections.current_page,
       data.inspections.last_page
      );
     }
    } catch (error) {
     document.getElementById("all-violators-tbody").innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                Error loading violators. Please try again.
            </td>
        </tr>
     `;
     // Clear pagination on error
     document.getElementById("all-violators-pagination").innerHTML = "";
    }
   };

   const renderAllViolatorsTable = (inspections) => {
    const tbody = document.getElementById("all-violators-tbody");
    tbody.innerHTML = "";

    if (!inspections || inspections.length === 0) {
     tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">No violators found</td>
            </tr>
        `;
     return;
    }

    inspections.forEach((inspection, index) => {
     // Get the pending violations only
     const pendingViolations = inspection.violations.filter(
      (v) => v.status.toLowerCase() === "pending"
     );

     if (pendingViolations.length === 0) return; // Skip if no pending violations

     const row = document.createElement("tr");
     row.className = "cursor-pointer hover-bg-light";
     row.style.cursor = "pointer"; // Add explicit cursor style

     const business = inspection.business;
     const owner = business.owner;

     row.innerHTML = `
            <td>${index + 1}</td>
            <td>${business.business_name || "N/A"}</td>
            <td>${owner.first_name || ""} ${owner.last_name || "N/A"}</td>
            <td>${business.status || "N/A"}</td>
            <td>${formatDate(inspection.inspection_date)}</td>
            <td>${formatDate(pendingViolations[0].due_date) || "N/A"}</td>
            <td>${inspection.type_of_inspection || "N/A"}</td>
            <td>
                <span class="badge ${
                 pendingViolations[0].status.toLowerCase() === "pending"
                  ? "bg-warning"
                  : pendingViolations[0].status.toLowerCase() === "paid"
                  ? "bg-success"
                  : pendingViolations[0].status.toLowerCase() === "overdue"
                  ? "bg-danger"
                  : "bg-secondary"
                } rounded-pill">
                    ${pendingViolations[0].status.toUpperCase()}
                </span>
            </td>
        `;

     // Add hover effect
     row.addEventListener("mouseenter", () => {
      row.classList.add("bg-light");
     });

     row.addEventListener("mouseleave", () => {
      row.classList.remove("bg-light");
     });

     row.addEventListener("click", () => showViolationDetails(inspection));
     tbody.appendChild(row);
    });
   };

   const renderAllViolatorsPagination = (currentPage, totalPages) => {
    const paginationElement = document.getElementById(
     "all-violators-pagination"
    );
    paginationElement.innerHTML = "";

    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton(
     "Previous",
     currentPage > 1,
     () => {
      if (currentPage > 1) getAllViolators(currentPage - 1);
     },
     "«"
    );
    paginationElement.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
     const pageButton = createPaginationButton(i.toString(), true, () => {
      getAllViolators(i);
     });
     if (i === currentPage) pageButton.classList.add("active");
     paginationElement.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton(
     "Next",
     currentPage < totalPages,
     () => {
      if (currentPage < totalPages) getAllViolators(currentPage + 1);
     },
     "»"
    );
    paginationElement.appendChild(nextButton);
   };

   // Add this to your existing initialization code
   getCardInfo();
   getViolators(1);
   getOverdueViolators(1);
   getAllViolators(1);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 </body>
</html>
