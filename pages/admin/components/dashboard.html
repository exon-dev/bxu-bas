<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BXU BAS: Dashboard</title>
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link
   href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css"
   rel="stylesheet"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
   rel="stylesheet"
  />
  <link
   rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.3.0/css/all.min.css"
   integrity="sha512-UJqci0ZyYcQ0AOJkcIkUCxLS2L6eNcOr7ZiypuInvEhO9uqIDi349MEFrqBzoy1QlfcjfURHl+WTMjEdWcv67A=="
   crossorigin="anonymous"
   referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="/css/admin/dashboard.css" />
  <style>
   body {
    font-family: "Poppins", sans-serif !important;
    background-color: #eff3fc;
    padding-right: 0 !important;
   }
   .card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
   }
   .order-card {
    color: #fff;
   }
   .bg-c-pink {
    background: #ff5370;
   }
   .bg-c-blue {
    background: #4099ff;
   }
   .bg-c-green {
    background: #2ed8b6;
   }
   .bg-c-yellow {
    background: #ffb64d;
   }
   .modal {
    padding-right: 0 !important;
   }
   .modal-body {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
   }
   .modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
   }
  </style>
  <!-- Add SweetAlert2 CSS and JS -->
  <link
   href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css"
   rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 </head>
 <body id="dashboard">
  <div class="card mb-4">
   <div class="card-body">
    <h4>Dashboard</h4>
    <p>
     Welcome to the BXU BAS Dashboard. Here you can monitor and manage all
     activities related to violators and inspectors.
    </p>
   </div>
  </div>
  <div class="row">
   <div class="col-md-4 col-xl-3">
    <div class="card bg-c-pink order-card">
     <div class="card-body">
      <h6 class="mb-2">Total Inspectors</h6>
      <div class="d-flex align-items-center gap-2">
       <i class="fa fa-user-tie text-white" aria-label="Inspectors Icon"></i>
       <h2 id="total_inspectors">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col-md-4 col-xl-3">
    <div class="card bg-c-blue order-card">
     <div class="card-body">
      <h6 class="mb-2">Total Inspections</h6>
      <div class="d-flex align-items-center gap-2">
       <i class="fa fa-users text-white" aria-label="Inspections Icon"></i>
       <h2 id="total_inspections">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col-md-4 col-xl-3">
    <div class="card bg-c-green order-card">
     <div class="card-body">
      <h6 class="mb-2">Total Violations</h6>
      <div class="d-flex align-items-center gap-2">
       <i
        class="fa fa-check-circle text-white"
        aria-label="Violations Icon"
       ></i>
       <h2 id="total_violations">0</h2>
      </div>
     </div>
    </div>
   </div>
   <div class="col-md-4 col-xl-3">
    <div class="card bg-c-yellow order-card">
     <div class="card-body">
      <h6 class="mb-2">Overdue Violations</h6>
      <div class="d-flex align-items-center gap-2">
       <i
        class="fa fa-exclamation-triangle text-white"
        aria-label="Overdue Icon"
       ></i>
       <h2 id="overdue_violations">0</h2>
      </div>
     </div>
    </div>
   </div>
  </div>
  <section>
   <div class="card">
    <div class="card-body">
     <h4>Upcoming Due</h4>
     <p>Violator with 3 days or less than 3 days are posted here.</p>
     <table class="table">
      <thead>
       <tr>
        <th>No.</th>
        <th>Business Name</th>
        <th>Business Status</th>
        <th>Inspector</th>
        <th>Inspection Date</th>
        <th>Due Date</th>
        <th>Type of Inspection</th>
        <th>Status</th>
       </tr>
      </thead>
      <tbody id="violators-tbody"></tbody>
     </table>
     <nav>
      <ul class="pagination" id="violators-pagination"></ul>
     </nav>
    </div>
   </div>
  </section>

  <section class="mt-4">
   <div class="card">
    <div class="card-body">
     <h4>Overdue Violations</h4>
     <p>Violators without resolving their dues are posted here.</p>
     <table class="table">
      <thead>
       <tr>
        <th>No.</th>
        <th>Business Name</th>
        <th>Business Status</th>
        <th>Inspector</th>
        <th>Inspection Date</th>
        <th>Days Overdue</th>
        <th>Status</th>
       </tr>
      </thead>
      <tbody id="overdue-tbody"></tbody>
     </table>
     <nav>
      <ul class="pagination" id="overdue-pagination"></ul>
     </nav>
    </div>
   </div>
  </section>

  <!-- Violation Detail Modal -->
  <div class="modal fade" id="violationDetailModal" tabindex="-1"></div>

  <script type="module">
   import CONFIG from "/scripts/config.js";

   const apiUrl = CONFIG.API_BASE_URL;

   console.log(apiUrl);

   const formatDate = (dateString) => {
    if (!dateString) return "N/A";
    const options = {
     year: "numeric",
     month: "long",
     day: "numeric",
    };
    return new Date(dateString).toLocaleDateString("en-US", options);
   };

   const getCardInfo = async () => {
    try {
     const res = await fetch(apiUrl + "/dashboard/card-info", {
      method: "GET",
      headers: {
       "Content-Type": "application/json",
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
     });

     console.log(res);

     if (!res.ok) {
      throw new Error(`Error: ${res.status} - ${res.statusText}`);
     }

     const data = await res.json();
     document.getElementById("total_inspectors").textContent =
      data.total_inspectors || 0;
     document.getElementById("total_inspections").textContent =
      data.total_inspections || 0;
     document.getElementById("total_violations").textContent =
      data.total_violations || 0;
     document.getElementById("overdue_violations").textContent =
      data.overdue_violations || 0;
    } catch (error) {
     console.error(error.message);
    }
   };

   const getViolators = async (page = 1) => {
    try {
     const violatorsTbody = document.getElementById("violators-tbody");
     violatorsTbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
    `;

     const response = await fetch(
      `${apiUrl}/inspection/upcoming-dues?page=${page}&with_violations=yes`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();
     console.log("Upcoming dues data:", data); // Debug log
     const inspections = data.inspections || [];

     renderViolatorsTable(inspections);
     // Update pagination if needed
     if (data.last_page > 1) {
      renderViolatorsPagination(data.current_page, data.last_page);
     }
    } catch (error) {
     console.error("Error fetching violators:", error);
     document.getElementById("violators-tbody").innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                Error loading violators. Please try again.
            </td>
        </tr>
    `;
    }
   };

   const renderViolatorsTable = (violators) => {
    const violatorsTbody = document.getElementById("violators-tbody");
    violatorsTbody.innerHTML = "";

    if (!violators || violators.length === 0) {
     violatorsTbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center">No upcoming dues found</td>
        </tr>
    `;
     return;
    }

    violators.forEach((inspection, index) => {
     const violation = inspection.violations[0]; // Get the first violation
     if (!violation) return; // Skip if no violation exists

     const row = document.createElement("tr");
     row.style.cursor = "pointer";

     row.innerHTML = `
        <td>${index + 1}</td>
        <td>${inspection.business?.business_name || "N/A"}</td>
        <td>${inspection.business?.status || "N/A"}</td>
        <td>${inspection.inspector?.first_name || ""} ${
      inspection.inspector?.last_name || "N/A"
     }</td>
        <td>${formatDate(inspection.inspection_date)}</td>
        <td>${formatDate(violation.due_date)}</td>
        <td>${inspection.type_of_inspection || "N/A"}</td>
        <td>
            <span class="badge ${
             violation.status === "pending"
              ? "bg-warning"
              : violation.status === "paid"
              ? "bg-success"
              : violation.status === "overdue"
              ? "bg-danger"
              : "bg-secondary"
            }">
                ${violation.status.toUpperCase()}
            </span>
        </td>
    `;

     row.addEventListener("click", () => showViolationDetails(inspection));
     violatorsTbody.appendChild(row);
    });
   };

   const renderViolatorsPagination = (currentPage, totalPages) => {
    const paginationElement = document.getElementById("violators-pagination");
    paginationElement.innerHTML = "";

    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton(
     "Previous",
     currentPage > 1,
     () => {
      if (currentPage > 1) getViolators(currentPage - 1);
     },
     "«"
    );
    paginationElement.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
     const pageButton = createPaginationButton(i.toString(), true, () => {
      getViolators(i);
     });
     if (i === currentPage) pageButton.classList.add("active");
     paginationElement.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton(
     "Next",
     currentPage < totalPages,
     () => {
      if (currentPage < totalPages) getViolators(currentPage + 1);
     },
     "»"
    );
    paginationElement.appendChild(nextButton);
   };

   const createPaginationButton = (label, enabled, onClick, symbol = null) => {
    const li = document.createElement("li");
    li.classList.add("page-item");
    if (!enabled) li.classList.add("disabled");

    const a = document.createElement("a");
    a.classList.add("page-link");
    a.href = "#";
    a.innerHTML = symbol || label;
    a.addEventListener("click", (e) => {
     e.preventDefault();
     if (enabled) onClick();
    });

    li.appendChild(a);
    return li;
   };

   const showViolationDetails = async (inspection) => {
    try {
     // Clean up any existing modals
     let modalElement = document.getElementById("violationDetailModal");
     if (modalElement) {
      modalElement.remove();
     }

     // Log the inspection object to verify we have the data
     console.log("Inspection object:", inspection);

     // Create modal content
     const detailedModalContent = `
            <div class="modal fade" id="violationDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-danger bg-gradient text-white">
                            <h5 class="modal-title fw-bold">
                                <i class="bi bi-exclamation-triangle me-2"></i>Violation Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <!-- Business Information -->
                            <div class="card border-0 shadow-sm hover-shadow mb-4">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-building fs-4 text-primary me-2"></i>Business Information
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="detail-item">
                                                <small class="text-muted d-block">Business Name</small>
                                                <span class="fw-semibold">${
                                                 inspection.business
                                                  ?.business_name || "N/A"
                                                }</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="detail-item">
                                                <small class="text-muted d-block">Business Permit</small>
                                                <span class="fw-semibold">${
                                                 inspection.business
                                                  ?.business_permit || "N/A"
                                                }</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Owner Information -->
                            <div class="card border-0 shadow-sm hover-shadow mb-4">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-person fs-4 text-primary me-2"></i>Owner Information
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="detail-item">
                                                <small class="text-muted d-block">Owner Name</small>
                                                <span class="fw-semibold">${
                                                 inspection.business?.owner
                                                  ?.first_name || ""
                                                } ${
      inspection.business?.owner?.last_name || "N/A"
     }</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="detail-item">
                                                <small class="text-muted d-block">Email</small>
                                                <span class="fw-semibold">${
                                                 inspection.business?.owner
                                                  ?.email || "N/A"
                                                }</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="detail-item">
                                                <small class="text-muted d-block">Phone</small>
                                                <span class="fw-semibold">${
                                                 inspection.business?.owner
                                                  ?.phone_number || "N/A"
                                                }</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Violations -->
                            <div class="card border-0 shadow-sm hover-shadow">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-exclamation-triangle fs-4 text-danger me-2"></i>Violations
                                    </h6>
                                    ${inspection.violations
                                     .map(
                                      (violation) => `
                                        <div class="violation-item p-3 bg-light rounded-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="fw-bold text-danger mb-2">Nature of Violations:</h6>
                                                    <ul class="list-unstyled mb-3">
                                                        ${violation.nature_of_violation
                                                         .map(
                                                          (nature) => `
                                                            <li class="mb-1">
                                                                <i class="bi bi-dot text-danger"></i>
                                                                ${nature.toUpperCase()}
                                                            </li>
                                                        `
                                                         )
                                                         .join("")}
                                                    </ul>
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <div class="detail-item">
                                                                <small class="text-muted d-block">Receipt No.</small>
                                                                <span class="fw-semibold">${
                                                                 violation.violation_receipt_no
                                                                }</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="detail-item">
                                                                <small class="text-muted d-block">Violation Date</small>
                                                                <span class="fw-semibold">${formatDate(
                                                                 violation.violation_date
                                                                )}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="detail-item">
                                                                <small class="text-muted d-block">Due Date</small>
                                                                <span class="fw-semibold">${formatDate(
                                                                 violation.due_date
                                                                )}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="ms-3">
                                                    <span class="badge ${
                                                     violation.status ===
                                                     "pending"
                                                      ? "bg-warning"
                                                      : violation.status ===
                                                        "paid"
                                                      ? "bg-success"
                                                      : violation.status ===
                                                        "overdue"
                                                      ? "bg-danger"
                                                      : "bg-secondary"
                                                    } rounded-pill px-3 py-2">
                                                        ${violation.status.toUpperCase()}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    `
                                     )
                                     .join("")}
                                </div>
                            </div>
                        </div>
                        <!-- Modal Footer with Resolve Button -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            ${
                             inspection.violations.some(
                              (v) => v.status !== "paid"
                             )
                              ? `<button 
                                    class="btn btn-success" 
                                    onclick="resolveInspection('${inspection.inspection_id}', this)"
                                    data-inspection-id="${inspection.inspection_id}"
                                >
                                    <i class="bi bi-check-circle me-2"></i>Resolve Violation
                                </button>`
                              : ""
                            }
                        </div>
                    </div>
                </div>
            </div>`;

     // Add modal to DOM and show it
     document.body.insertAdjacentHTML("beforeend", detailedModalContent);
     const modal = new bootstrap.Modal(
      document.getElementById("violationDetailModal")
     );
     modal.show();

     // Clean up modal on close
     document
      .getElementById("violationDetailModal")
      .addEventListener("hidden.bs.modal", function () {
       this.remove();
       const backdrops = document.getElementsByClassName("modal-backdrop");
       while (backdrops.length > 0) {
        backdrops[0].remove();
       }
      });
    } catch (error) {
     console.error("Error showing violation details:", error);
    }
   };

   window.resolveInspection = async (inspectionId, button) => {
    // Get inspection ID from data attribute as fallback
    inspectionId = inspectionId || button.dataset.inspectionId;

    console.log("Inspection ID:", inspectionId); // Debug log

    const originalContent = button.innerHTML;

    try {
     if (!inspectionId) {
      throw new Error("No inspection ID provided");
     }

     // Disable button and show loading state
     button.disabled = true;
     button.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Resolving...
        `;

     const response = await fetch(
      `${apiUrl}/inspection/resolve-inspection/${inspectionId}`,
      {
       method: "PUT",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error("Response:", errorData);
      throw new Error(`Failed to resolve inspection: ${response.status}`);
     }

     // Show success message
     try {
      Swal.fire({
       icon: "success",
       title: "Success!",
       text: "Inspection has been resolved successfully.",
       showConfirmButton: false,
       timer: 1500,
      });
     } catch (e) {
      alert("Inspection has been resolved successfully.");
     }

     // Refresh the data
     await Promise.all([
      getCardInfo(),
      getViolators(1),
      getOverdueViolators(1),
     ]);

     // Close the modal
     const modal = bootstrap.Modal.getInstance(
      document.getElementById("violationDetailModal")
     );
     if (modal) {
      modal.hide();
     }
    } catch (error) {
     console.error("Error resolving inspection:", error);

     // Reset button state
     button.disabled = false;
     button.innerHTML = originalContent;

     // Show error message
     try {
      Swal.fire({
       icon: "error",
       title: "Error",
       text: error.message || "Failed to resolve inspection. Please try again.",
      });
     } catch (e) {
      alert(error.message || "Failed to resolve inspection. Please try again.");
     }
    }
   };

   const getOverdueViolators = async (page = 1) => {
    try {
     const overdueTbody = document.getElementById("overdue-tbody");
     overdueTbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `;

     const response = await fetch(
      `${apiUrl}/inspection/overdue-violations?page=${page}`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();
     console.log("Overdue data:", data); // Debug log

     // Access the inspections array directly since it's a different endpoint
     const inspections = data.inspections || [];

     renderOverdueTable(inspections);
     if (data.last_page > 1) {
      renderOverduePagination(data.current_page, data.last_page);
     }
    } catch (error) {
     console.error("Error fetching overdue violators:", error);
     document.getElementById("overdue-tbody").innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Error loading overdue violations. Please try again.
                </td>
            </tr>
        `;
    }
   };

   const renderOverdueTable = (inspections) => {
    const overdueTbody = document.getElementById("overdue-tbody");
    overdueTbody.innerHTML = "";

    if (!Array.isArray(inspections) || inspections.length === 0) {
     overdueTbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">No overdue violations found</td>
            </tr>
        `;
     return;
    }

    inspections.forEach((inspection, index) => {
     const violation = inspection.violations?.[0]; // Safe access of first violation
     if (!violation) return;

     const row = document.createElement("tr");
     row.style.cursor = "pointer";

     row.innerHTML = `
            <td>${index + 1}</td>
            <td>${inspection.business?.business_name || "N/A"}</td>
            <td>${inspection.business?.status || "N/A"}</td>
            <td>${inspection.inspector?.first_name || ""} ${
      inspection.inspector?.last_name || "N/A"
     }</td>
            <td>${formatDate(inspection.inspection_date)}</td>
            <td>
                <span class="badge bg-danger">
                    ${Math.floor(violation.days_overdue)} days
                </span>
            </td>
            <td>
                <span class="badge bg-danger">OVERDUE</span>
            </td>
        `;

     row.addEventListener("click", () => showViolationDetails(inspection));
     overdueTbody.appendChild(row);
    });
   };

   const renderOverduePagination = (currentPage, totalPages) => {
    const paginationElement = document.getElementById("overdue-pagination");
    paginationElement.innerHTML = "";

    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton(
     "Previous",
     currentPage > 1,
     () => {
      if (currentPage > 1) getOverdueViolators(currentPage - 1);
     },
     "«"
    );
    paginationElement.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
     const pageButton = createPaginationButton(i.toString(), true, () =>
      getOverdueViolators(i)
     );
     if (i === currentPage) pageButton.classList.add("active");
     paginationElement.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton(
     "Next",
     currentPage < totalPages,
     () => {
      if (currentPage < totalPages) getOverdueViolators(currentPage + 1);
     },
     "»"
    );
    paginationElement.appendChild(nextButton);
   };

   // Fetch data on page load
   getCardInfo();
   getViolators(1);
   getOverdueViolators();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 </body>
</html>
