<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspections</title>
  <link
   rel="stylesheet"
   href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/css/bootstrap.min.css"
  />
  <link
   rel="stylesheet"
   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />
 </head>
 <style>
  body {
   font-family: "Poppins", Arial, sans-serif !important;
   background-color: #eff3fc;
   margin: 0;
   padding: 0;
  }
  .card {
   border-radius: 10px;
   -webkit-box-shadow: 0 1px 2.94px 0.06px rgba(4, 26, 55, 0.16);
   box-shadow: 0 1px 2.94px 0.06px rgba(4, 26, 55, 0.16);
   border: none;
   margin-bottom: 30px;
   -webkit-transition: all 0.3s ease-in-out;
   transition: all 0.3s ease-in-out;
  }

  .hover-shadow {
   transition: all 0.3s ease;
  }

  .hover-shadow:hover {
   transform: translateY(-2px);
   box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .inspection-row {
   cursor: pointer;
   transition: background-color 0.2s ease;
  }

  .inspection-row:hover {
   background-color: rgba(0, 0, 0, 0.05);
  }

  .modal-content {
   border-radius: 0.5rem;
  }

  .modal-header {
   border-radius: 0.5rem 0.5rem 0 0;
  }

  .violation-item {
   transition: transform 0.2s ease;
  }

  .violation-item:hover {
   transform: translateX(5px);
  }

  .detail-item {
   padding: 0.5rem;
   background: white;
   border-radius: 0.5rem;
  }

  .badge {
   font-weight: 500;
   letter-spacing: 0.5px;
  }

  .modal-body {
   max-height: 70vh;
   overflow-y: auto;
  }

  .table-hover tbody tr:hover {
   background-color: rgba(0, 0, 0, 0.05) !important;
   cursor: pointer;
  }
 </style>
 <body>
  <div class="card">
   <div class="card-body">
    <h4>Business Inspection</h4>
    <p>Inspect business and create violations for business violators</p>
    <button
     class="btn btn-primary"
     id="openModalBtn"
     data-bs-toggle="modal"
     data-bs-target="#violatorModal"
    >
     Add Inspection
    </button>
   </div>
  </div>

  <!-- Modal Structure -->
  <div
   class="modal fade"
   id="violatorModal"
   tabindex="-1"
   aria-labelledby="violatorModalLabel"
   aria-hidden="true"
  >
   <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-3 shadow-lg">
     <div class="modal-header border-0">
      <h5 class="modal-title" id="violatorModalLabel">
       <span id="modalActionText">Add</span> Business Inspection
      </h5>
      <button
       type="button"
       class="btn-close"
       data-bs-dismiss="modal"
       aria-label="Close"
      ></button>
     </div>
     <div class="modal-body" style="max-height: 500px">
      <form id="inspectionForm">
       <input type="hidden" id="inspectionId" name="inspectionId" value="" />
       <!-- Owner's Information -->
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="ownerFirstName" class="form-label"
          >Owner's First Name:</label
         >
         <input
          type="text"
          class="form-control form-control-sm"
          id="ownerFirstName"
          name="ownerFirstName"
          required
         />
        </div>
        <div class="col-md-6">
         <label for="ownerLastName" class="form-label"
          >Owner's Last Name:</label
         >
         <input
          type="text"
          class="form-control form-control-sm"
          id="ownerLastName"
          name="ownerLastName"
          required
         />
        </div>
       </div>
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="ownerEmail" class="form-label">Owner's Email:</label>
         <input
          type="email"
          class="form-control form-control-sm"
          id="ownerEmail"
          name="ownerEmail"
         />
        </div>
        <div class="col-md-6">
         <label for="ownerPhoneNumber" class="form-label"
          >Owner's Phone Number:</label
         >
         <input
          type="text"
          class="form-control form-control-sm"
          id="ownerPhoneNumber"
          name="ownerPhoneNumber"
          required
         />
        </div>
       </div>

       <!-- Business Information -->
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="businessName" class="form-label">Business Name:</label>
         <input
          type="text"
          class="form-control form-control-sm"
          id="businessName"
          name="businessName"
          required
         />
        </div>
        <div class="col-md-6">
         <label for="businessPermit" class="form-label">Business Permit:</label>
         <input
          type="text"
          class="form-control form-control-sm"
          id="businessPermit"
          name="businessPermit"
         />
        </div>
       </div>
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="businessStatus" class="form-label">Business Status:</label>
         <select
          class="form-select form-control-sm"
          id="businessStatus"
          name="businessStatus"
          required
         >
          <option value="low_income">Low Income</option>
          <option value="with_permit">With Permit</option>
          <option value="without_permit">Without Permit</option>
          <option value="already_closed">Already Closed</option>
          <option value="already_closed_new_business">
           Already Closed but New Business Operating
          </option>
          <option value="still_operating">Still Operating</option>
         </select>
        </div>
       </div>

       <!-- Address Information -->
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="street" class="form-label">Street:</label>
         <input
          type="text"
          class="form-control form-control-sm"
          id="street"
          name="street"
          required
         />
        </div>
        <div class="col-md-6">
         <label for="city" class="form-label">City:</label>
         <input
          type="text"
          class="form-control form-control-sm"
          id="city"
          name="city"
          required
         />
        </div>
       </div>
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="zip" class="form-label">ZIP Code:</label>
         <input
          type="text"
          class="form-control form-control-sm"
          id="zip"
          name="zip"
          required
         />
        </div>
       </div>

       <!-- Inspection Details -->
       <div class="row mb-2">
        <div class="col-md-6">
         <label for="typeOfInspection" class="form-label"
          >Type of Inspection:</label
         >
         <select
          class="form-select form-control-sm"
          id="typeOfInspection"
          name="typeOfInspection"
          required
         >
          <option value="regular">Regular</option>
          <option value="night">Night</option>
          <option value="special_change_address">
           Special (Change Address)
          </option>
          <option value="special_verification">Special (Verification)</option>
          <option value="special_complaint">Special (Complaint)</option>
          <option value="special_retirement">Special (Retirement)</option>
          <option value="joint">Joint</option>
         </select>
        </div>
        <div class="col-md-6">
         <label for="withViolations" class="form-label">With Violations:</label>
         <select
          class="form-select form-control-sm"
          id="withViolations"
          name="withViolations"
          required
         >
          <option value="true">Yes</option>
          <option value="false" selected>No</option>
         </select>
        </div>
       </div>

       <div
        class="row mb-3"
        id="natureOfViolationContainer"
        style="display: none"
       >
        <div class="col-md-12 mb-3">
         <label class="form-label">Nature of Violation:</label>
         <div
          class="violation-checkboxes border rounded p-3"
          style="max-height: 200px; overflow-y: auto"
         >
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="no mayors permit"
            name="natureOfViolation[]"
            id="violation1"
           />
           <label class="form-check-label" for="violation1">
            NO MAYOR'S PERMIT
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="non display of mayors permit"
            name="natureOfViolation[]"
            id="violation2"
           />
           <label class="form-check-label" for="violation2">
            NON-DISPLAY OF MAYOR'S PERMIT
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="displaying dilapidated mayors permit"
            name="natureOfViolation[]"
            id="violation3"
           />
           <label class="form-check-label" for="violation3">
            DISPLAYING DILAPIDATED MAYOR'S PERMIT
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="displaying counterfeit mayors permit"
            name="natureOfViolation[]"
            id="violation4"
           />
           <label class="form-check-label" for="violation4">
            DISPLAYING A COUNTERFEIT MAYOR'S PERMIT
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="understatement of gross sales"
            name="natureOfViolation[]"
            id="violation5"
           />
           <label class="form-check-label" for="violation5">
            UNDERSTATEMENT AND/OR INCORRECT DECLARATION OF GROSS SALES OR
            RECEIPTS
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="falsification of business permit"
            name="natureOfViolation[]"
            id="violation6"
           />
           <label class="form-check-label" for="violation6">
            FALSIFICATION AND/OR ALTERATION OF BUSINESS PERMIT
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="sidewalk obstruction"
            name="natureOfViolation[]"
            id="violation7"
           />
           <label class="form-check-label" for="violation7">
            SIDEWALK/STREET/SIDESTREET OBSTRUCTION
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="non posting of notice"
            name="natureOfViolation[]"
            id="violation8"
           />
           <label class="form-check-label" for="violation8">
            NON-POSTING OF NOTICE
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="non declaration of business"
            name="natureOfViolation[]"
            id="violation9"
           />
           <label class="form-check-label" for="violation9">
            NON-DECLARATION OF TYPE OR NATURE OF BUSINESS
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="drinking in public places"
            name="natureOfViolation[]"
            id="violation10"
           />
           <label class="form-check-label" for="violation10">
            DRINKING IN PUBLIC PLACES
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="unauthorized serving of liquor"
            name="natureOfViolation[]"
            id="violation11"
           />
           <label class="form-check-label" for="violation11">
            UNAUTHORIZED SERVING OF LIQUOR
           </label>
          </div>
          <div class="form-check">
           <input
            class="form-check-input"
            type="checkbox"
            value="unauthorized selling of liquor"
            name="natureOfViolation[]"
            id="violation12"
           />
           <label class="form-check-label" for="violation12">
            UNAUTHORIZED SELLING OF LIQUOR
           </label>
          </div>
         </div>
        </div>
        <div class="row mb-3">
         <div class="col-md-6">
          <label for="violationReceipt" class="form-label"
           >Violation Receipt No.:</label
          >
          <input
           type="text"
           class="form-control form-control-sm"
           id="violationReceipt"
           name="violationReceipt"
          />
         </div>
         <div class="col-md-6">
          <label for="dueDate" class="form-label">Due Date:</label>
          <input
           type="date"
           class="form-control form-control-sm"
           id="dueDate"
           name="dueDate"
          />
         </div>
        </div>
       </div>

       <div class="row mb-2">
        <div class="col-md-12">
         <label for="businessImage" class="form-label">Business Image:</label>
         <input
          type="file"
          class="form-control form-control-sm"
          id="businessImage"
          name="businessImage"
          accept="image/*"
         />
        </div>
       </div>
      </form>
     </div>
     <div class="modal-footer border-0 shadow-lg">
      <button
       type="submit"
       class="btn btn-primary h6"
       form="inspectionForm"
       id="submitButton"
      >
       <span id="submitButtonText">Submit</span>
      </button>
     </div>
    </div>
   </div>
  </div>

  <!-- Add Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
   <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
     <div class="modal-header">
      <h5 class="modal-title">Success</h5>
      <button
       type="button"
       class="btn-close"
       data-bs-dismiss="modal"
       aria-label="Close"
      ></button>
     </div>
     <div class="modal-body">
      <p>Inspection has been successfully saved!</p>
     </div>
     <div class="modal-footer">
      <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
       Close
      </button>
     </div>
    </div>
   </div>
  </div>

  <div
   class="modal fade"
   id="inspectionDetailModal"
   tabindex="-1"
   aria-labelledby="inspectionDetailModalLabel"
   aria-hidden="true"
  >
   <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
     <div class="modal-header">
      <h5 class="modal-title" id="inspectionDetailModalLabel">
       Inspection Details
      </h5>
      <button
       type="button"
       class="btn-close"
       data-bs-dismiss="modal"
       aria-label="Close"
      ></button>
     </div>
     <div class="modal-body" style="max-height: 70vh; overflow-y: auto">
      <!-- Your modal content goes here -->
     </div>
     <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
       Close
      </button>
     </div>
    </div>
   </div>
  </div>
  <section class="card mt-3">
   <div class="card-body">
    <h4>Inspected Businesses</h4>
    <section class="card mt-3">
     <div class="card-body">
      <h4 class="mb-4">Filter & Search</h4>
      <div class="filters">
       <form id="filters-form">
        <div class="row g-3">
         <div class="col-md-4">
          <label for="search-name" class="form-label"
           >Search Business Name</label
          >
          <input
           type="text"
           id="search-name"
           class="form-control"
           placeholder="Enter business name..."
          />
         </div>
         <div class="col-md-4">
          <label for="receipt-no" class="form-label">Receipt No:</label>
          <input
           type="text"
           class="form-control"
           id="receipt-no"
           placeholder="Search by violation receipt no..."
          />
         </div>
         <div class="col-md-4">
          <label for="inspection-date" class="form-label"
           >Filter by Inspection Date</label
          >
          <input type="date" id="inspection-date" class="form-control" />
         </div>
         <div class="col-md-4">
          <label for="violation" class="form-label">Filter by Violation</label>
          <select id="violation" class="form-select">
           <option value="">Select Violation</option>
           <option value="yes">Yes</option>
           <option value="no">No</option>
          </select>
         </div>
         <div class="col-md-4">
          <label for="sort-order" class="form-label">Sort by Date</label>
          <select id="sort-order" class="form-select">
           <option value="latest">Latest to Oldest</option>
           <option value="oldest">Oldest to Latest</option>
          </select>
         </div>
        </div>
       </form>
      </div>
     </div>
    </section>
    <table class="table table-hover">
     <thead>
      <tr>
       <th>No.</th>
       <th>Business Name</th>
       <th>Business Status</th>
       <th>Inspection Date</th>
       <th>Type of Inspection</th>
       <th>With Violations</th>
       <th></th>
      </tr>
     </thead>
     <tbody id="inspections-tbody">
      <!-- Rendered rows will be inserted here -->
     </tbody>
    </table>
   </div>
  </section>

  <nav>
   <ul class="pagination" id="pagination-controls"></ul>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/js/bootstrap.min.js"></script>
  <script type="module">
   import CONFIG from "/scripts/config.js";

   const apiUrl = CONFIG.API_BASE_URL;

   // Add this debug log to verify the URL

   let recordsPerPage = 20; // Default value
   let currentPage = 1; // Initialize currentPage to 1
   let totalPages = 1;
   let inspectionsData = [];
   let timeoutId = null;

   const formatDate = (dateString) => {
    if (!dateString) return "N/A"; // Return "N/A" if no date is provided
    const date = new Date(dateString);
    // Format the date as MM/DD/YYYY
    const options = { year: "numeric", month: "2-digit", day: "2-digit" };
    return date.toLocaleDateString(undefined, options);
   };

   const violationStatus = document.getElementById("withViolations");
   const natureOfViolationContainer = document.getElementById(
    "natureOfViolationContainer"
   );

   violationStatus.addEventListener("change", function () {
    natureOfViolationContainer.style.display =
     violationStatus.value === "true" ? "block" : "none";
   });

   // Function to toggle required attributes based on the "With Violations" selection
   const toggleViolationFields = () => {
    const withViolationsSelect = document.getElementById("withViolations");
    const violationReceiptInput = document.getElementById("violationReceipt");
    const dueDateInput = document.getElementById("dueDate");
    const violationCheckboxes = document.querySelectorAll(
     'input[name="natureOfViolation[]"]'
    );
    const violationContainer = document.querySelector(".violation-checkboxes");

    const hasViolations = withViolationsSelect.value === "true";

    // Remove required from individual checkboxes but add custom validation
    violationCheckboxes.forEach((checkbox) => (checkbox.required = false));
    violationReceiptInput.required = hasViolations;
    dueDateInput.required = hasViolations;

    // Add custom validation on form submit
    const form = withViolationsSelect.closest("form");
    form.onsubmit = (e) => {
     if (hasViolations) {
      const checkedViolations = document.querySelectorAll(
       'input[name="natureOfViolation[]"]:checked'
      );
      if (checkedViolations.length === 0) {
       e.preventDefault();
       alert("Please select at least one violation");
       violationContainer.scrollIntoView({ behavior: "smooth" });
       return false;
      }
     }
     return true;
    };
   };

   // Add event listener to the "With Violations" select element
   document
    .getElementById("withViolations")
    .addEventListener("change", toggleViolationFields);

   // Initial call to set the required attributes correctly on page load
   toggleViolationFields();

   // Add cleanup modal function at the top level
   const cleanupModal = () => {
    // Remove modal backdrop
    const backdrops = document.getElementsByClassName("modal-backdrop");
    while (backdrops.length > 0) {
     backdrops[0].remove();
    }

    // Reset body styles
    document.body.classList.remove("modal-open");
    document.body.style.overflow = "";
    document.body.style.paddingRight = "";
   };

   // Update the form submission handler
   inspectionForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    // Get the submit button and store its original content
    const submitButton = document.getElementById("submitButton");
    const originalContent = submitButton.innerHTML;

    try {
     // Disable button and show loading state
     submitButton.disabled = true;
     submitButton.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            ${isEditing ? "Updating..." : "Submitting..."}
        `;

     const formData = new FormData();

     // Map form fields to backend expected names
     formData.append(
      "owner_first_name",
      document.getElementById("ownerFirstName").value
     );
     formData.append(
      "owner_last_name",
      document.getElementById("ownerLastName").value
     );
     formData.append(
      "owner_email",
      document.getElementById("ownerEmail").value
     );
     formData.append(
      "owner_phone_number",
      document.getElementById("ownerPhoneNumber").value
     );
     formData.append(
      "business_name",
      document.getElementById("businessName").value
     );
     formData.append(
      "business_permit",
      document.getElementById("businessPermit").value
     );
     formData.append(
      "business_status",
      document.getElementById("businessStatus").value
     );
     formData.append("street", document.getElementById("street").value);
     formData.append("city", document.getElementById("city").value);
     formData.append("zip", document.getElementById("zip").value);
     formData.append(
      "type_of_inspection",
      document.getElementById("typeOfInspection").value
     );

     // Handle with_violations
     const withViolationsValue =
      document.getElementById("withViolations").value;
     formData.append("with_violations", withViolationsValue);

     // Handle violations if "Yes" is selected
     if (withViolationsValue === "true") {
      const selectedViolations = Array.from(
       document.querySelectorAll('input[name="natureOfViolation[]"]:checked')
      ).map((cb) => cb.value);

      selectedViolations.forEach((violation) => {
       formData.append("nature_of_violations[]", violation);
      });

      formData.append(
       "violation_receipt",
       document.getElementById("violationReceipt").value
      );
      formData.append("due_date", document.getElementById("dueDate").value);
     }

     // Handle file upload
     const businessImage = document.getElementById("businessImage").files[0];
     if (businessImage) {
      formData.append("image", businessImage);
     }

     // Add inspection ID for updates
     const inspectionId = document.getElementById("inspectionId").value;
     if (isEditing) {
      formData.append("_method", "PUT");
     }

     const endpoint = isEditing
      ? `${apiUrl}/inspector/update-inspection/${inspectionId}`
      : `${apiUrl}/inspector/add-inspection`;

     const response = await fetch(endpoint, {
      method: "POST",
      headers: {
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
      body: formData,
     });

     if (!response.ok) {
      const errorData = await response.json();
      throw new Error(
       errorData.message || `HTTP error! status: ${response.status}`
      );
     }

     // Hide the form modal and cleanup
     const violatorModal = bootstrap.Modal.getInstance(
      document.getElementById("violatorModal")
     );
     violatorModal.hide();
     cleanupModal();

     // Show success modal
     const successModal = new bootstrap.Modal(
      document.getElementById("successModal")
     );
     successModal.show();

     // Reset form and refresh table
     resetForm();
     fetchInspections(currentPage);
    } catch (error) {
     console.error("Submission error:", error);
     // Show error in a more user-friendly way
     const errorAlert = document.createElement("div");
     errorAlert.className = "alert alert-danger alert-dismissible fade show";
     errorAlert.innerHTML = `
            <strong>Error!</strong> ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

     // Insert the alert at the top of the form
     inspectionForm.insertBefore(errorAlert, inspectionForm.firstChild);

     // Remove the alert after 5 seconds
     setTimeout(() => {
      errorAlert.remove();
     }, 5000);
    } finally {
     // Always restore the button to its original state
     submitButton.disabled = false;
     submitButton.innerHTML = originalContent;
    }
   });

   // Add event listeners for modal hidden events
   document
    .getElementById("violatorModal")
    .addEventListener("hidden.bs.modal", function () {
     cleanupModal();
    });

   document
    .getElementById("successModal")
    .addEventListener("hidden.bs.modal", function () {
     cleanupModal();
    });

   // Add event listener for the violations select
   document
    .getElementById("withViolations")
    .addEventListener("change", function () {
     const violationsContainer = document.getElementById(
      "natureOfViolationContainer"
     );
     const violationReceipt = document.getElementById("violationReceipt");
     const dueDate = document.getElementById("dueDate");
     const violationCheckboxes = document.querySelectorAll(
      'input[name="natureOfViolation[]"]'
     );

     if (this.value === "true") {
      violationsContainer.style.display = "block";
      violationReceipt.required = true;
      dueDate.required = true;
      // At least one violation checkbox should be checked
      violationCheckboxes.forEach((checkbox) => {
       checkbox.addEventListener("change", validateViolations);
      });
     } else {
      violationsContainer.style.display = "none";
      violationReceipt.required = false;
      dueDate.required = false;
      // Remove validation from checkboxes
      violationCheckboxes.forEach((checkbox) => {
       checkbox.removeEventListener("change", validateViolations);
       checkbox.checked = false;
      });
      violationReceipt.value = "";
      dueDate.value = "";
     }
    });

   // Function to validate that at least one violation is checked
   function validateViolations() {
    const violationCheckboxes = document.querySelectorAll(
     'input[name="natureOfViolation[]"]:checked'
    );
    if (violationCheckboxes.length === 0) {
     // Show error message or handle validation
     return false;
    }
    return true;
   }

   // Delete functionality
   document.querySelectorAll(".delete-btn").forEach((button) => {
    button.addEventListener("click", function () {
     if (confirm("Are you sure you want to delete this inspection?")) {
      const row = this.closest("tr");
      const inspectionId = this.dataset.id;
      // Add your delete logic here

      // Remove row from table
      row.remove();
     }
    });
   });

   const renderTable = () => {
    const inspectionsTbody = document.getElementById("inspections-tbody");
    inspectionsTbody.innerHTML = "";

    if (!inspectionsData || inspectionsData.length === 0) {
     const noDataRow = document.createElement("tr");
     noDataRow.innerHTML = `
            <td colspan="6" class="text-center">No inspections found</td>
        `;
     inspectionsTbody.appendChild(noDataRow);
     return;
    }

    inspectionsData.forEach((inspection, index) => {
     const row = document.createElement("tr");
     row.className = "inspection-row";
     row.style.cursor = "pointer";
     const actualIndex = (currentPage - 1) * recordsPerPage + index + 1;

     row.innerHTML = `
            <td>${actualIndex}</td>
            <td>${inspection.business?.business_name || "N/A"}</td>
            <td>${inspection.business?.status || "N/A"}</td>
            <td>${formatDate(inspection.inspection_date)}</td>
            <td>${inspection.type_of_inspection || "N/A"}</td>
            <td class="align-middle">
                <span class="badge ${
                 inspection.with_violations ? "bg-danger" : "bg-success"
                } py-2 px-3">
                    ${inspection.with_violations ? "Yes" : "No"}
                </span>
            </td>
            <td class="align-middle text-end">
                <button class="btn btn-sm btn-primary edit-inspection" 
                    data-inspection-id="${inspection.inspection_id}">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
        `;

     // Add click event listener to show inspection details
     row.addEventListener("click", (e) => {
      // Don't show details if clicking the edit button
      if (!e.target.closest(".edit-inspection")) {
       showInspectionDetails(inspection);
      }
     });

     inspectionsTbody.appendChild(row);
    });

    renderPagination();
   };

   const fetchInspections = async (page = 1) => {
    try {
     const inspectionsTbody = document.getElementById("inspections-tbody");
     inspectionsTbody.innerHTML = `
             <tr>
                 <td colspan="7" class="text-center">
                     <div class="spinner-border text-primary" role="status">
                         <span class="visually-hidden">Loading...</span>
                     </div>
                 </td>
             </tr>
         `;

     const inspectionDate = document.getElementById("inspection-date").value;
     const violation = document.getElementById("violation").value;
     const receiptNo = document.getElementById("receipt-no").value;
     const searchName = document.getElementById("search-name").value;
     const sortOrder = document.getElementById("sort-order").value;
     const sortOrderParam = sortOrder === "oldest" ? "asc" : "desc";

     const params = new URLSearchParams({
      page: page,
      ...(inspectionDate && { inspection_date: inspectionDate }),
      ...(violation && { with_violations: violation }),
      ...(receiptNo && { violation_receipt_no: receiptNo }),
      ...(searchName && { business_name: searchName }),
      sort_order: sortOrderParam,
     });

     const response = await fetch(
      `${apiUrl}/inspector/inspections?${params.toString()}`,
      {
       method: "GET",
       headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`API request failed with status ${response.status}`);
     }

     const data = await response.json();
     inspectionsData = data.inspections.data || [];
     totalPages = data.inspections.last_page || 1;
     currentPage = data.inspections.current_page || 1;
     recordsPerPage = data.inspections.per_page || 15;

     renderTable();
    } catch (error) {
     console.error("Error fetching inspections:", error);
     const inspectionsTbody = document.getElementById("inspections-tbody");
     inspectionsTbody.innerHTML = `
             <tr>
                 <td colspan="7" class="text-center text-danger">
                     Error loading inspections. Please try again.
                 </td>
             </tr>
         `;
    }
   };

   // First, define the debounce function at the top of your script
   const debounce = (func, delay) => {
    let timeoutId;
    return (...args) => {
     clearTimeout(timeoutId);
     timeoutId = setTimeout(() => func.apply(null, args), delay);
    };
   };

   // Create a debounced version of fetchInspections
   const debouncedFetchInspections = debounce((page = 1) => {
    fetchInspections(page);
   }, 300);

   // Update your filter setup
   const setupFilterListeners = () => {
    const filterElements = [
     "search-name",
     "inspection-date",
     "violation",
     "receipt-no",
     "sort-order",
    ];

    filterElements.forEach((elementId) => {
     const element = document.getElementById(elementId);
     if (element) {
      // Remove any existing listeners first
      const newElement = element.cloneNode(true);
      element.parentNode.replaceChild(newElement, element);

      // Add the new listener
      newElement.addEventListener("input", () => {
       currentPage = 1;
       debouncedFetchInspections(currentPage);
      });

      newElement.addEventListener("change", () => {
       currentPage = 1;
       debouncedFetchInspections(currentPage);
      });
     }
    });
   };

   const renderPagination = () => {
    const paginationControls = document.getElementById("pagination-controls");
    paginationControls.innerHTML = "";

    if (totalPages <= 1) return;

    const prevPageButton = document.createElement("li");
    prevPageButton.classList.add("page-item");
    prevPageButton.innerHTML = `
          <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
          </a>
      `;
    prevPageButton.addEventListener("click", (e) => {
     e.preventDefault();
     if (currentPage > 1) changePage(currentPage - 1);
    });
    if (currentPage === 1) prevPageButton.classList.add("disabled");
    paginationControls.appendChild(prevPageButton);

    for (let i = 1; i <= totalPages; i++) {
     const pageButton = document.createElement("li");
     pageButton.classList.add("page-item");
     if (i === currentPage) pageButton.classList.add("active");
     pageButton.innerHTML = `<a class="page-link" href="#">${i}</a>`;
     pageButton.addEventListener("click", (e) => {
      e.preventDefault();
      changePage(i);
     });
     paginationControls.appendChild(pageButton);
    }

    const nextPageButton = document.createElement("li");
    nextPageButton.classList.add("page-item");
    nextPageButton.innerHTML = `
          <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
          </a>
      `;
    nextPageButton.addEventListener("click", (e) => {
     e.preventDefault();
     if (currentPage < totalPages) changePage(currentPage + 1);
    });
    if (currentPage === totalPages) nextPageButton.classList.add("disabled");
    paginationControls.appendChild(nextPageButton);
   };

   const changePage = (newPage) => {
    currentPage = newPage; // Update the current page
    fetchInspections(currentPage); // Fetch inspections for the new page
   };

   // Call the functions to set up the listeners and fetch initial data
   setupFilterListeners();
   fetchInspections();

   // Function to show inspection details in the modal
   const getImageUrl = (imageUrl) => {
    if (!imageUrl) return null;
    return `${CONFIG.APP_URL}/storage/${imageUrl}`;
   };

   const showInspectionDetails = async (inspection) => {
    try {
     // Clean up any existing modals, backdrops, and styles
     let modalElement = document.getElementById("inspectionDetailModal");
     if (modalElement) {
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      if (modalInstance) {
       modalInstance.dispose();
      }
      modalElement.remove();
     }

     // Remove any lingering backdrops and cleanup styles
     const backdrops = document.getElementsByClassName("modal-backdrop");
     while (backdrops.length > 0) {
      backdrops[0].remove();
     }

     // Reset any padding-right that might have been added to the body
     document.body.style.paddingRight = "";
     document.body.style.overflow = "";
     document.body.classList.remove("modal-open");

     // Show loading state
     const loadingModal = `
            <div class="modal fade" id="inspectionDetailModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading inspection details...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
     document.body.insertAdjacentHTML("beforeend", loadingModal);
     const modal = new bootstrap.Modal(
      document.getElementById("inspectionDetailModal")
     );
     modal.show();

     // Fetch inspection details
     const response = await fetch(
      `${apiUrl}/inspection/inspections/${inspection.inspection_id}`,
      {
       headers: {
        Accept: "application/json",
        Authorization: `Bearer ${localStorage.getItem("authToken")}`,
       },
      }
     );

     if (!response.ok) {
      throw new Error(`Failed to fetch inspection details: ${response.status}`);
     }

     const data = await response.json();
     const inspectionDetails = data.inspection;

     // Create violations list - Modified to handle the new violations structure
     const violationsList = Object.values(inspectionDetails.violations)
      .map(
       (violation) => `
                <div class="violation-item mb-3 p-3 bg-light rounded-3 border-start border-4 border-danger shadow-sm">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="violation-main">
                            <h6 class="fw-bold text-danger mb-2">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                ${violation.nature_of_violation.join(", ")}
                            </h6>
                            <div class="violation-details">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <small class="text-muted d-block">Receipt No.</small>
                                            <span class="fw-semibold">${
                                             violation.violation_receipt_no
                                            }</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <small class="text-muted d-block">Violation Date</small>
                                            <span class="fw-semibold">${formatDate(
                                             violation.violation_date
                                            )}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <small class="text-muted d-block">Due Date</small>
                                            <span class="fw-semibold">${formatDate(
                                             violation.due_date
                                            )}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3">
                            <span class="badge ${
                             violation.status.toLowerCase() === "pending"
                              ? "bg-warning"
                              : violation.status.toLowerCase() === "paid"
                              ? "bg-success"
                              : violation.status.toLowerCase() === "overdue"
                              ? "bg-danger"
                              : "bg-secondary"
                            } rounded-pill px-3 py-2">
                                ${violation.status}
                            </span>
                        </div>
                    </div>
                </div>
            `
      )
      .join("");

     // Create the detailed modal content
     const detailedModalContent = `
    <div class="modal fade" id="inspectionDetailModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0 bg-primary bg-gradient text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-clipboard2-check me-2"></i>Inspection Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Business Image Section -->
                    <div class="text-center mb-4">
                        ${
                         inspectionDetails.image_url
                          ? `<div class="position-relative d-inline-block">
                                <img src="${getImageUrl(
                                 inspectionDetails.image_url
                                )}" 
                                    alt="Business Image" 
                                    class="rounded-3 shadow-sm" 
                                    style="max-height: 200px; width: auto; object-fit: cover"
                                    onerror="this.onerror=null; this.src='/assets/images/no-image.png';"
                                >
                                <div class="position-absolute bottom-0 start-0 p-2 bg-dark bg-opacity-75 text-white rounded-bottom w-100">
                                    <small>${
                                     inspectionDetails.business.business_name
                                    }</small>
                                </div>
                            </div>`
                          : `<div class="text-center p-4 bg-light rounded-3">
                                <i class="bi bi-building-x display-1 text-muted"></i>
                                <p class="text-muted mt-2">No business image available</p>
                            </div>`
                        }
                    </div>

                    <div class="row g-4">
                        <!-- Business Information -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm hover-shadow">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-building fs-4 text-primary me-2"></i>Business Information
                                    </h6>
                                    <div class="mb-3">
                                        <label class="text-muted small">Business Name</label>
                                        <p class="fw-semibold mb-2">${
                                         inspectionDetails.business
                                          ?.business_name || "N/A"
                                        }</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="text-muted small">Business Permit</label>
                                        <p class="fw-semibold mb-2">${
                                         inspectionDetails.business
                                          ?.business_permit || "N/A"
                                        }</p>
                                    </div>
                                    <div>
                                        <label class="text-muted small">Status</label>
                                        <p class="mb-0">
                                            <span class="badge bg-success rounded-pill">${
                                             inspectionDetails.business
                                              ?.status || "N/A"
                                            }</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Owner Information -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm hover-shadow">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-person fs-4 text-primary me-2"></i>Owner Information
                                    </h6>
                                    <div class="mb-3">
                                        <label class="text-muted small">Owner Name</label>
                                        <p class="fw-semibold mb-2">${
                                         inspectionDetails.business?.owner
                                          ?.first_name
                                        } ${
      inspectionDetails.business?.owner?.last_name
     }</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="text-muted small">
                                            <i class="bi bi-envelope-fill me-1"></i>Email
                                        </label>
                                        <p class="fw-semibold mb-2">${
                                         inspectionDetails.business?.owner
                                          ?.email || "N/A"
                                        }</p>
                                    </div>
                                    <div>
                                        <label class="text-muted small">
                                            <i class="bi bi-telephone-fill me-1"></i>Phone
                                        </label>
                                        <p class="fw-semibold mb-0">${
                                         inspectionDetails.business?.owner
                                          ?.phone_number || "N/A"
                                        }</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Business Location -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm hover-shadow">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-geo-alt-fill fs-4 text-primary me-2"></i>Business Location
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">Street Address</label>
                                            <p class="fw-semibold mb-0">${
                                             inspectionDetails.business?.address
                                              ?.street_address || "N/A"
                                            }</p>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">City</label>
                                            <p class="fw-semibold mb-0">${
                                             inspectionDetails.business?.address
                                              ?.city || "N/A"
                                            }</p>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">Postal Code</label>
                                            <p class="fw-semibold mb-0">${
                                             inspectionDetails.business?.address
                                              ?.postal_code || "N/A"
                                            }</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Inspection Details -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm hover-shadow">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="bi bi-clipboard-data fs-4 text-primary me-2"></i>Inspection Details
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">Inspection Date</label>
                                            <p class="fw-semibold mb-0">${formatDate(
                                             inspectionDetails.inspection_date
                                            )}</p>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">Type of Inspection</label>
                                            <p class="fw-semibold mb-0">${
                                             inspectionDetails.type_of_inspection
                                            }</p>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="text-muted small">Inspector</label>
                                            <p class="fw-semibold mb-0">${
                                             inspectionDetails.inspector
                                              ?.first_name
                                            } ${
      inspectionDetails.inspector?.last_name
     }</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Violations Section -->
                        <div class="col-12">
                            <div class="violations-section mt-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-clipboard-x fs-4 text-danger me-2"></i>Violations Found
                                </h6>
                                ${
                                 inspectionDetails.violations.length > 0
                                  ? `<div class="list-group">
                                        ${inspectionDetails.violations
                                         .map(
                                          (violation, index) => `
                                            <div class="list-group-item list-group-item-action border-0 mb-2 rounded-3 shadow-sm hover-shadow">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="violation-main flex-grow-1">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="violations-list">
                                                                <h6 class="fw-bold text-danger mb-2">Nature of Violations:</h6>
                                                                <ul class="list-unstyled mb-0">
                                                                    ${violation.nature_of_violation
                                                                     .map(
                                                                      (
                                                                       nature
                                                                      ) => `
                                                                            <li class="mb-1">
                                                                                <i class="bi bi-dot text-danger"></i>
                                                                                ${nature
                                                                                 .trim()
                                                                                 .toUpperCase()}
                                                                            </li>
                                                                        `
                                                                     )
                                                                     .join("")}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="violation-details mt-3">
                                                            <div class="row g-3">
                                                                <div class="col-md-4">
                                                                    <div class="detail-item">
                                                                        <small class="text-muted d-block">Receipt No.</small>
                                                                        <span class="fw-semibold">${
                                                                         violation.violation_receipt_no
                                                                        }</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="detail-item">
                                                                        <small class="text-muted d-block">Violation Date</small>
                                                                        <span class="fw-semibold">${formatDate(
                                                                         violation.violation_date
                                                                        )}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="detail-item">
                                                                        <small class="text-muted d-block">Due Date</small>
                                                                        <span class="fw-semibold">${formatDate(
                                                                         violation.due_date
                                                                        )}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="ms-3">
                                                        <span class="badge ${
                                                         violation.status.toLowerCase() ===
                                                         "pending"
                                                          ? "bg-warning"
                                                          : violation.status.toLowerCase() ===
                                                            "paid"
                                                          ? "bg-success"
                                                          : violation.status.toLowerCase() ===
                                                            "overdue"
                                                          ? "bg-danger"
                                                          : "bg-secondary"
                                                        } rounded-pill px-3 py-2">
                                                            ${violation.status.toUpperCase()}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        `
                                         )
                                         .join("")}
                                    </div>`
                                  : `<div class="text-center p-4 bg-light rounded-3">
                                        <i class="bi bi-check-circle text-success display-4"></i>
                                        <p class="text-muted mt-2">No violations found</p>
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
`;

     // Remove loading modal and show detailed modal
     modalElement = document.getElementById("inspectionDetailModal");
     if (modalElement) {
      modalElement.remove();
     }

     document.body.insertAdjacentHTML("beforeend", detailedModalContent);
     const detailedModal = new bootstrap.Modal(
      document.getElementById("inspectionDetailModal")
     );
     detailedModal.show();

     // Add cleanup on modal hide
     detailedModal._element.addEventListener("hidden.bs.modal", function () {
      // Clean up modal and styles
      this.remove();
      document.body.style.paddingRight = "";
      document.body.style.overflow = "";
      document.body.classList.remove("modal-open");

      // Remove any remaining backdrops
      const backdrops = document.getElementsByClassName("modal-backdrop");
      while (backdrops.length > 0) {
       backdrops[0].remove();
      }
     });
    } catch (error) {
     console.error("Error showing inspection details:", error);
     // Show error modal
     const errorModal = `
            <div class="modal fade" id="inspectionDetailModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center p-5">
                            <i class="bi bi-exclamation-circle text-danger display-4"></i>
                            <p class="mt-3">Error loading inspection details. Please try again.</p>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
     document.body.insertAdjacentHTML("beforeend", errorModal);
     const errorModalInstance = new bootstrap.Modal(
      document.getElementById("inspectionDetailModal")
     );
     errorModalInstance.show();
    }
   };

   // Example: Add event listeners to inspection rows or buttons
   document.querySelectorAll(".inspection-row").forEach((row) => {
    row.addEventListener("click", () => {
     const inspectionId = row.dataset.inspectionId;
     // Fetch the inspection data using the ID
     const inspection = getInspectionById(inspectionId); // Implement this function to fetch data
     showInspectionDetails(inspection);
    });
   });

   // Function to fetch inspection data by ID (example implementation)
   function getInspectionById(id) {
    // This is a placeholder function. Replace with actual data fetching logic.
    return inspectionsData.find((inspection) => inspection.id === id);
   }

   // Ensure that the modal is initialized correctly
   document
    .getElementById("inspectionDetailModal")
    .addEventListener("show.bs.modal", function () {
     // Bootstrap handles the body overflow automatically
    });

   document
    .getElementById("inspectionDetailModal")
    .addEventListener("hidden.bs.modal", function () {
     // Bootstrap handles the body overflow automatically
    });

   let isEditing = false;

   const resetForm = () => {
    document.getElementById("inspectionForm").reset();
    document.getElementById("inspectionId").value = "";
    document.getElementById("natureOfViolationContainer").style.display =
     "none";
    isEditing = false;
    document.getElementById("modalActionText").textContent = "Add";
    document.getElementById("submitButtonText").textContent = "Submit";
   };

   const populateForm = (inspection) => {
    // Basic fields
    document.getElementById("ownerFirstName").value =
     inspection.business?.owner?.first_name || "";
    document.getElementById("ownerLastName").value =
     inspection.business?.owner?.last_name || "";
    document.getElementById("ownerEmail").value =
     inspection.business?.owner?.email || "";
    document.getElementById("ownerPhoneNumber").value =
     inspection.business?.owner?.phone_number || "";
    document.getElementById("businessName").value =
     inspection.business?.business_name || "";
    document.getElementById("businessPermit").value =
     inspection.business?.business_permit || "";
    document.getElementById("businessStatus").value =
     inspection.business?.status || "";

    // Address fields
    document.getElementById("street").value =
     inspection.business?.address?.street_address || "";
    document.getElementById("city").value =
     inspection.business?.address?.city || "";
    document.getElementById("zip").value =
     inspection.business?.address?.postal_code || "";

    // Inspection fields
    document.getElementById("typeOfInspection").value =
     inspection.type_of_inspection;
    document.getElementById("withViolations").value = inspection.with_violations
     ? "true"
     : "false";

    // Handle violations
    if (
     inspection.with_violations &&
     inspection.violations &&
     Array.isArray(inspection.violations)
    ) {
     document.getElementById("withViolations").value = "true";
     document.getElementById("natureOfViolationContainer").style.display =
      "block";

     // Reset all checkboxes first
     document
      .querySelectorAll('input[name="natureOfViolation[]"]')
      .forEach((cb) => (cb.checked = false));

     // Check the relevant violations
     inspection.violations.forEach((violation) => {
      if (Array.isArray(violation.nature_of_violation)) {
       violation.nature_of_violation.forEach((nature) => {
        const checkbox = Array.from(
         document.querySelectorAll('input[name="natureOfViolation[]"]')
        ).find((cb) => cb.value.toLowerCase() === nature.toLowerCase());
        if (checkbox) checkbox.checked = true;
       });

       if (violation.violation_receipt_no) {
        document.getElementById("violationReceipt").value =
         violation.violation_receipt_no;
       }
       if (violation.due_date) {
        document.getElementById("dueDate").value =
         violation.due_date.split("T")[0];
       }
      }
     });
    } else {
     document.getElementById("withViolations").value = "false";
     document.getElementById("natureOfViolationContainer").style.display =
      "none";
    }
   };

   // Update form submission handler
   inspectionForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    // Get the submit button and store its original content
    const submitButton = document.getElementById("submitButton");
    const originalContent = submitButton.innerHTML;

    try {
     // Disable button and show loading state
     submitButton.disabled = true;
     submitButton.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            ${isEditing ? "Updating..." : "Submitting..."}
        `;

     const formData = new FormData();

     // Map form fields to backend expected names
     formData.append(
      "owner_first_name",
      document.getElementById("ownerFirstName").value
     );
     formData.append(
      "owner_last_name",
      document.getElementById("ownerLastName").value
     );
     formData.append(
      "owner_email",
      document.getElementById("ownerEmail").value
     );
     formData.append(
      "owner_phone_number",
      document.getElementById("ownerPhoneNumber").value
     );
     formData.append(
      "business_name",
      document.getElementById("businessName").value
     );
     formData.append(
      "business_permit",
      document.getElementById("businessPermit").value
     );
     formData.append(
      "business_status",
      document.getElementById("businessStatus").value
     );
     formData.append("street", document.getElementById("street").value);
     formData.append("city", document.getElementById("city").value);
     formData.append("zip", document.getElementById("zip").value);
     formData.append(
      "type_of_inspection",
      document.getElementById("typeOfInspection").value
     );

     // Handle with_violations
     const withViolationsValue =
      document.getElementById("withViolations").value;
     formData.append("with_violations", withViolationsValue);

     // Handle violations if "Yes" is selected
     if (withViolationsValue === "true") {
      const selectedViolations = Array.from(
       document.querySelectorAll('input[name="natureOfViolation[]"]:checked')
      ).map((cb) => cb.value);

      selectedViolations.forEach((violation) => {
       formData.append("nature_of_violations[]", violation);
      });

      formData.append(
       "violation_receipt",
       document.getElementById("violationReceipt").value
      );
      formData.append("due_date", document.getElementById("dueDate").value);
     }

     // Handle file upload
     const businessImage = document.getElementById("businessImage").files[0];
     if (businessImage) {
      formData.append("image", businessImage);
     }

     // Add inspection ID for updates
     const inspectionId = document.getElementById("inspectionId").value;
     if (isEditing) {
      formData.append("_method", "PUT");
     }

     const endpoint = isEditing
      ? `${apiUrl}/inspector/update-inspection/${inspectionId}`
      : `${apiUrl}/inspector/add-inspection`;

     const response = await fetch(endpoint, {
      method: "POST",
      headers: {
       Authorization: `Bearer ${localStorage.getItem("authToken")}`,
      },
      body: formData,
     });

     if (!response.ok) {
      const errorData = await response.json();
      throw new Error(
       errorData.message || `HTTP error! status: ${response.status}`
      );
     }

     // Hide the form modal and cleanup
     const violatorModal = bootstrap.Modal.getInstance(
      document.getElementById("violatorModal")
     );
     violatorModal.hide();
     cleanupModal();

     // Show success modal
     const successModal = new bootstrap.Modal(
      document.getElementById("successModal")
     );
     successModal.show();

     // Reset form and refresh table
     resetForm();
     fetchInspections(currentPage);
    } catch (error) {
     console.error("Submission error:", error);
     // Show error in a more user-friendly way
     const errorAlert = document.createElement("div");
     errorAlert.className = "alert alert-danger alert-dismissible fade show";
     errorAlert.innerHTML = `
            <strong>Error!</strong> ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

     // Insert the alert at the top of the form
     inspectionForm.insertBefore(errorAlert, inspectionForm.firstChild);

     // Remove the alert after 5 seconds
     setTimeout(() => {
      errorAlert.remove();
     }, 5000);
    } finally {
     // Always restore the button to its original state
     submitButton.disabled = false;
     submitButton.innerHTML = originalContent;
    }
   });

   // Add click handler for edit buttons
   document.addEventListener("click", async function (e) {
    if (e.target.closest(".edit-inspection")) {
     e.preventDefault();
     e.stopPropagation(); // Stop the click event from bubbling up to the row

     const button = e.target.closest(".edit-inspection");
     const inspectionId = button.dataset.inspectionId;

     try {
      const response = await fetch(
       `${apiUrl}/inspection/inspections/${inspectionId}`,
       {
        headers: {
         Accept: "application/json",
         Authorization: `Bearer ${localStorage.getItem("authToken")}`,
        },
       }
      );

      if (!response.ok)
       throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();
      isEditing = true;
      document.getElementById("modalActionText").textContent = "Update";
      document.getElementById("submitButtonText").textContent = "Update";
      document.getElementById("inspectionId").value = inspectionId;

      populateForm(data.inspection);

      const modal = new bootstrap.Modal(
       document.getElementById("violatorModal")
      );
      modal.show();
     } catch (error) {
      console.error("Error fetching inspection details:", error);
     }
    }
   });

   // Reset form when modal is hidden
   document
    .getElementById("violatorModal")
    .addEventListener("hidden.bs.modal", resetForm);

   // Add event listeners for modal hidden events
   document
    .getElementById("violatorModal")
    .addEventListener("hidden.bs.modal", function () {
     cleanupModal();
    });

   document
    .getElementById("successModal")
    .addEventListener("hidden.bs.modal", function () {
     cleanupModal();
    });

   // Call setupFilterListeners after the DOM is loaded
   document.addEventListener("DOMContentLoaded", () => {
    setupFilterListeners();
    fetchInspections(currentPage);
   });
  </script>
 </body>
</html>
